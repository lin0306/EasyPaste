<script setup lang="ts">import {isMac} from "../../../data/SystemParams.ts";import {openLink} from "../../../utils/LinkUtil.ts";import HintIcon from "../../../assets/icons/HintIcon.vue";import {  currentConfig,  currentShortcutKeys,  onLoading,  originalConfig,  originalShortcutKeys} from "../composables/SettingsDataComposable.ts";import {getTray, languages, useLanguage} from "../../../services/LanguageService.ts";import {computed, onMounted, ref} from "vue";import {  getAlwaysOnTop,  getAutoHideWindow,  getBindTagBtnShowLocation,  getEnableTag,  getPowerOnSelfStart,  getReplaceGlobalHotkey,  saveAlwaysOnTop, saveAutoGoToLatestData,  saveAutoHideWindow,  saveBindTagBtnShowLocation,  saveEnableTag,  saveLanguage,  savePowerOnSelfStart,  saveReplaceGlobalHotkey} from "../../../store/Settings.ts";import {disable, enable, isEnabled} from "@tauri-apps/plugin-autostart";import {error, info} from "@tauri-apps/plugin-log";import {emit} from "@tauri-apps/api/event";import {invoke} from "@tauri-apps/api/core";import {convertRegisterKey} from "../../../utils/ShortcutKeysUtil.ts";import {isRegistered, register, unregister} from "@tauri-apps/plugin-global-shortcut";import {saveLanguageCache} from "../../../services/FileService.ts";import {useMessage} from "naive-ui";import {getWakeUpRoutine} from "../../../store/ShortcutKeys.ts";import {SETTINGS} from "../../../constants/UserSettingsConstant.ts";const {currentLanguage, toggleLanguage} = useLanguage();const message = useMessage();// 语言选项const languageOptions = languages.map(lang => ({  value: lang.id,  label: lang.name}));// 标签绑定按钮位置const bindTagBtnShowLocation = computed(() => [{  value: SETTINGS.GENERATE.BIND_TAG_LOCATION.TOP_RIGHT,  label: currentLanguage.value.pages.settings.topRight,}, {  value: SETTINGS.GENERATE.BIND_TAG_LOCATION.BOTTOM_RIGHT,  label: currentLanguage.value.pages.settings.bottomRight,}]);// 重启确认弹窗状态const restartModalVisible = ref(false);// 当前程序是否占用系统快捷键const systemClipboardKeyOccupied = ref(false);// 系统剪贴板是否启用const systemClipboardEnable = ref(false);// 系统剪贴板未启用的情况下，系统剪贴板快捷键是否被注册const systemClipboardKeysRegistered = ref(false);// 当前程序是否为管理员启动const isAdminStart = ref(false);/** * 更新系统快捷键 */async function updateToSystemShortcutKeys() {  const key = ['meta', 'v'];  // 没有找到注册表配置，直接修改快捷键  info("唤醒程序快捷键已修改，重新注册");  // 注销快捷键  try {    const keys: string[] = originalShortcutKeys.wakeUpRoutine.key;    const registerKey = convertRegisterKey(keys);    if (await isRegistered(registerKey)) {      // 如果已经注册了快捷键，需要先取消注册，再重新注册      await unregister(registerKey);    }  } catch (e) {    info("快捷键注销失败" + e);  }  // 修改快捷键  currentShortcutKeys.wakeUpRoutine.key = key;  await emit('update-open-window-key', {keys: currentShortcutKeys});}/** * 修改开机自启配置 * @param powerOnSelfStart 是否开机自启 */async function onChangePowerOnSelfStart(powerOnSelfStart: boolean) {  onLoading.value = true;  try {    await savePowerOnSelfStart(powerOnSelfStart);    const enabled = await isEnabled();    if (powerOnSelfStart !== enabled) {      if (powerOnSelfStart) {        // 启用自启动        await enable();      } else {        // 禁用自启动        await disable();      }    }    originalConfig.powerOnSelfStart = powerOnSelfStart;    currentConfig.powerOnSelfStart = powerOnSelfStart;  } catch (e) {    error('修改自启动设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.powerOnSelfStart = originalConfig.powerOnSelfStart;  } finally {    onLoading.value = false;  }}/** * 修改自动隐藏窗口配置 * @param autoHideWindow 是否自动隐藏窗口 */async function onChangeAutoHideWindow(autoHideWindow: boolean) {  onLoading.value = true;  try {    await saveAutoHideWindow(autoHideWindow);    originalConfig.autoHideWindow = autoHideWindow;    currentConfig.autoHideWindow = autoHideWindow;    // 发送更新了启用标签状态消息    await emit('update-auto-hide-window', {isAutoHide: currentConfig.autoHideWindow});  } catch (e) {    error('修改自动隐藏窗口设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.autoHideWindow = originalConfig.autoHideWindow;  } finally {    onLoading.value = false;  }}/** * 修改窗口置顶配置 * @param alwaysOnTop 是否置顶 */async function onChangeAlwaysOnTop(alwaysOnTop: boolean) {  onLoading.value = true;  try {    await saveAlwaysOnTop(alwaysOnTop);    // 发送更新了窗口置顶状态消息    await emit('update-always-on-top', {isTop: currentConfig.alwaysOnTop});    originalConfig.alwaysOnTop = alwaysOnTop;    currentConfig.alwaysOnTop = alwaysOnTop;  } catch (e) {    error('修改窗口置顶设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.alwaysOnTop = originalConfig.alwaysOnTop;  } finally {    onLoading.value = false;  }}/** * 修改替换全局热键配置 * @param replaceGlobalHotkey 是否替换全局热键 */async function onChangeReplaceGlobalHotkey(replaceGlobalHotkey: boolean) {  onLoading.value = true;  try {    // 打开替换全局热键    if (currentConfig.replaceGlobalHotkey) {      const enable = await invoke<boolean>('valid_clipboard_regedit');      if (!enable) {        await updateToSystemShortcutKeys();      } else {        // 有找到注册表配置，需要修改注册表，再修改快捷键        const backupResult = await invoke<boolean>('backup_clipboard_regedit');        if (!backupResult) {          console.log("备份注册表失败");          message.error(currentLanguage.value.pages.settings.enableReplaceGlobalHotkeyFailedMsg);          // 回滚【替换全局热键】设置          currentConfig.replaceGlobalHotkey = !currentConfig.replaceGlobalHotkey;          return;        } else {          await updateToSystemShortcutKeys();          // 显示重启确认弹窗          restartModalVisible.value = true;        }      }    } else {      // 关闭全局热键，重置快捷键      info("唤醒程序快捷键已修改，重新注册");      const valid = await invoke<boolean>('valid_clipboard_backup_regedit');      let isBackupSuccess = true;      if (valid) {        // 恢复注册表配置        const backupResult = await invoke<boolean>('recover_clipboard_regedit');        if (!backupResult) {          console.log("恢复注册表失败");          message.error(currentLanguage.value.pages.settings.disableReplaceGlobalHotkeyFailedMsg);          // 回滚【替换全局热键】设置          currentConfig.replaceGlobalHotkey = !currentConfig.replaceGlobalHotkey;          isBackupSuccess = false;        }      }      if (isBackupSuccess) {        // 注销快捷键        try {          const keys: string[] = originalShortcutKeys.wakeUpRoutine.key;          const registerKey = convertRegisterKey(keys);          if (await isRegistered(registerKey)) {            // 如果已经注册了快捷键，需要先取消注册，再重新注册            await unregister(registerKey);          }        } catch (e) {          info("快捷键注销失败" + e);        }        // 修改快捷键        currentShortcutKeys.wakeUpRoutine.key = ['alt', 'c'];        await emit('update-open-window-key', {keys: currentShortcutKeys});        if (valid) {          // 显示重启确认弹窗          restartModalVisible.value = true;        }      } else {        return;      }    }    await saveReplaceGlobalHotkey(replaceGlobalHotkey);    originalConfig.replaceGlobalHotkey = replaceGlobalHotkey;    currentConfig.replaceGlobalHotkey = replaceGlobalHotkey;  } catch (e) {    error('修改窗口置顶设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.replaceGlobalHotkey = originalConfig.replaceGlobalHotkey;  } finally {    onLoading.value = false;  }}/** * 修改语言 * @param languages 语言 */async function onChangeLanguages(languages: string) {  if (languages === originalConfig.languages) {    // 忽略点击重复项的情况    return;  }  onLoading.value = true;  try {    await saveLanguage(languages);    // 更新语言    await toggleLanguage(currentConfig.languages);    // 保存语言    await saveLanguageCache(getTray(currentConfig.languages));    // 重新加载托盘菜单    await invoke('reload_tray_menu');    originalConfig.languages = languages;    currentConfig.languages = languages;  } catch (e) {    error('修改语言设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.languages = originalConfig.languages;  } finally {    onLoading.value = false;  }}/** * 修改是否启用标签 * @param enableTag 是否启用标签 */async function onChangeEnableTag(enableTag: boolean) {  onLoading.value = true;  try {    await saveEnableTag(enableTag);    // 发送更新了启用标签状态消息    await emit('update-tag-setting-state', {      isShow: currentConfig.enableTag,      location: currentConfig.bindTagBtnShowLocation,    });    originalConfig.enableTag = enableTag;    currentConfig.enableTag = enableTag;  } catch (e) {    error('修改是否启用标签设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.enableTag = originalConfig.enableTag;  } finally {    onLoading.value = false;  }}/** * 修改标签按钮显示位置 * @param bindTagBtnShowLocation 标签按钮显示位置 */async function onChangeBindTagBtnShowLocation(bindTagBtnShowLocation: string) {  if (bindTagBtnShowLocation === originalConfig.bindTagBtnShowLocation) {    return;  }  onLoading.value = true;  try {    await saveBindTagBtnShowLocation(bindTagBtnShowLocation);    // 发送更新了启用标签状态消息    await emit('update-tag-setting-state', {      isShow: currentConfig.enableTag,      location: currentConfig.bindTagBtnShowLocation,    });    originalConfig.bindTagBtnShowLocation = bindTagBtnShowLocation;    currentConfig.bindTagBtnShowLocation = bindTagBtnShowLocation;  } catch (e) {    error('修改标签按钮显示位置设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.bindTagBtnShowLocation = originalConfig.bindTagBtnShowLocation;  } finally {    onLoading.value = false;  }}/** * 修改是否自动跳转到最新数据 * @param autoGoToLatestData 是否自动跳转到最新数据 */async function onChangeAutoGoToLatestData(autoGoToLatestData: boolean) {  onLoading.value = true;  try {    await saveAutoGoToLatestData(autoGoToLatestData);    originalConfig.autoGoToLatestData = autoGoToLatestData;    currentConfig.autoGoToLatestData = autoGoToLatestData;    // 发送更新了启用标签状态消息    await emit('update-auto-go-to-latest-data', {isGoToLatestData: currentConfig.autoGoToLatestData});  } catch (e) {    error('修改自动跳转到最新数据设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.autoGoToLatestData = originalConfig.autoGoToLatestData;  } finally {    onLoading.value = false;  }}// 处理重启电脑const handleRestart = async () => {  restartModalVisible.value = false;  await invoke('restart_computer');};// 加载配置onMounted(async () => {  try {    // 初始化用户配置    const powerOnSelfStart = await getPowerOnSelfStart();    originalConfig.powerOnSelfStart = powerOnSelfStart;    currentConfig.powerOnSelfStart = powerOnSelfStart;    const replaceGlobalHotkey = await getReplaceGlobalHotkey();    originalConfig.replaceGlobalHotkey = replaceGlobalHotkey;    currentConfig.replaceGlobalHotkey = replaceGlobalHotkey;    const enableTag = await getEnableTag();    originalConfig.enableTag = enableTag;    currentConfig.enableTag = enableTag;    const bindTagBtnShowLocation = await getBindTagBtnShowLocation();    originalConfig.bindTagBtnShowLocation = bindTagBtnShowLocation;    currentConfig.bindTagBtnShowLocation = bindTagBtnShowLocation;    const autoHideWindow = await getAutoHideWindow();    originalConfig.autoHideWindow = autoHideWindow;    currentConfig.autoHideWindow = autoHideWindow;    const alwaysOnTop = await getAlwaysOnTop();    originalConfig.alwaysOnTop = alwaysOnTop;    currentConfig.alwaysOnTop = alwaysOnTop;    if (!isMac) {      const wakeUpRoutineKey = await getWakeUpRoutine();      // 系统剪贴板快捷键占用检查      systemClipboardKeyOccupied.value = JSON.stringify(wakeUpRoutineKey.key) === JSON.stringify(['meta', 'v']);      if (!systemClipboardKeyOccupied.value) {        // 检测系统剪贴板快捷键是否可用        systemClipboardEnable.value = await invoke('valid_clipboard_regedit');        if (!systemClipboardEnable.value) {          const key = ['meta', 'v'];          try {            await register(convertRegisterKey(key), () => {            });            systemClipboardKeysRegistered.value = false;            await unregister(convertRegisterKey(key));          } catch (e) {            systemClipboardKeysRegistered.value = true;          }        } else {          isAdminStart.value = await invoke('check_admin');        }      }    }  } catch (e) {    console.error('页面初始化失败:', e);    error("页面初始化失败：" + e);    message.error(currentLanguage.value.pages.settings.initFailedHint);  }});</script><template>  <div class="settings-section">    <h2>{{ currentLanguage.pages.settings.generalTitle }}</h2>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.powerOnSelfStart }}</span>      <n-switch v-model:value="currentConfig.powerOnSelfStart"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangePowerOnSelfStart"      />    </div>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.autoHideWindow }}</span>      <n-switch v-model:value="currentConfig.autoHideWindow"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeAutoHideWindow"      />    </div>    <div class="form-item" v-if="!currentConfig.autoHideWindow">      <span class="label">{{ currentLanguage.pages.settings.alwaysOnTop }}</span>      <n-switch v-model:value="currentConfig.alwaysOnTop"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeAlwaysOnTop"      />    </div>    <div class="line" v-if="!isMac">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.replaceGlobalHotkey }}</span>        <n-switch v-model:value="currentConfig.replaceGlobalHotkey"                  :disabled="(systemClipboardEnable && !isAdminStart) || (!systemClipboardEnable && !systemClipboardKeyOccupied && systemClipboardKeysRegistered) || onLoading"                  :loading="onLoading"                  @update:value="onChangeReplaceGlobalHotkey"        />      </div>      <div class="second-item"           v-if="!systemClipboardKeyOccupied && !systemClipboardEnable && systemClipboardKeysRegistered">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">                  {{ currentLanguage.pages.settings.shortcutKeyOccupationHint }}                </span>        </div>      </div>      <div class="second-item" v-else-if="systemClipboardEnable && !isAdminStart">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">                  {{ currentLanguage.pages.settings.replaceGlobalHotkeyNoPermissionHint }}                  <a href="#"                     @click="openLink('https://github.com/lin0306/EasyPaste/blob/master/FAQ/rights_of_administrators/rights_of_administrators.md')">                    {{ currentLanguage.pages.settings.replaceGlobalHotkeyLinkHint }}                  </a>                </span>        </div>      </div>      <div class="second-item" v-else>        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">                  {{ currentLanguage.pages.settings.replaceGlobalHotkeyHint }}                </span>        </div>      </div>    </div>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.languages }}</span>      <n-select class="select"                v-model:value="currentConfig.languages"                :options="languageOptions"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeLanguages"      />    </div>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.enableTag }}</span>      <n-switch v-model:value="currentConfig.enableTag"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeEnableTag"      />    </div>    <div class="form-item" v-if="currentConfig.enableTag">      <span class="label">{{ currentLanguage.pages.settings.bindTagBtnShowLocation }}</span>      <n-select class="select"                v-model:value="currentConfig.bindTagBtnShowLocation"                :options="bindTagBtnShowLocation"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeBindTagBtnShowLocation"      />    </div>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.autoGoToLatestData }}</span>      <n-switch v-model:value="currentConfig.autoGoToLatestData"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeAutoGoToLatestData"      />    </div>    <!-- 重启确认弹窗 -->    <n-modal v-model:show="restartModalVisible" :title="currentLanguage.pages.settings.restartModalTitle"             preset="dialog">      <p>{{ currentLanguage.pages.settings.restartModalContent }}</p>      <template #action>        <n-button @click="restartModalVisible = false">          {{ currentLanguage.pages.settings.restartModalCancelBtn }}        </n-button>        <n-button type="primary" @click="handleRestart">          {{ currentLanguage.pages.settings.restartModalConfirmBtn }}        </n-button>      </template>    </n-modal>  </div></template><style scoped></style>