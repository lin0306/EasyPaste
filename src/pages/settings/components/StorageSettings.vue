<script setup lang="ts">import HintIcon from "../../../assets/icons/HintIcon.vue";import {currentConfig, onLoading, originalConfig} from "../composables/SettingsDataComposable.ts";import {useMessage} from "naive-ui";import {  getDataRetentionDays,  getImageBasePath,  getMaxHistoryItems,  saveDataRetentionDays,  saveImageBasePath,  saveMaxHistoryItems} from "../../../store/Settings.ts";import {emit} from "@tauri-apps/api/event";import {error} from "@tauri-apps/plugin-log";import {onMounted, ref} from "vue";import {currentLanguage} from "../../../services/LanguageService.ts";import SelectFileIcon from "../../../assets/icons/SelectFileIcon.vue";import {open} from '@tauri-apps/plugin-dialog';import {appDataDir} from "@tauri-apps/api/path";import {isMac} from "../../../data/SystemParams.ts";const message = useMessage();const defaultPath = ref('');/** * 修改最大历史记录项数 */async function onChangeMaxHistoryItems() {  if (currentConfig.maxHistoryItems !== originalConfig.maxHistoryItems) {    onLoading.value = true;    try {      await saveMaxHistoryItems(currentConfig.maxHistoryItems);      await emit('update-data-history-restrict', {        maxHistoryItems: currentConfig.maxHistoryItems,        dataRetentionDays: currentConfig.dataRetentionDays      });      originalConfig.maxHistoryItems = currentConfig.maxHistoryItems;    } catch (e) {      error('修改最大历史记录项数设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.maxHistoryItems = originalConfig.maxHistoryItems;    } finally {      onLoading.value = false;    }  }}/** * 修改数据保留天数 */async function onChangeDataRetentionDays() {  if (currentConfig.dataRetentionDays !== originalConfig.dataRetentionDays) {    onLoading.value = true;    try {      await saveDataRetentionDays(currentConfig.dataRetentionDays);      await emit('update-data-history-restrict', {        maxHistoryItems: currentConfig.maxHistoryItems,        dataRetentionDays: currentConfig.dataRetentionDays      });      originalConfig.dataRetentionDays = currentConfig.dataRetentionDays;    } catch (e) {      error('修改数据保留天数设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.dataRetentionDays = originalConfig.dataRetentionDays;    } finally {      onLoading.value = false;    }  }}async function onSelectFile() {  console.log('选择文件夹')  const file = await open({    multiple: false,    directory: true,    defaultPath: currentConfig.imageBasePath,    canCreateDirectories: true,  });  console.log(file);  if (file) {    currentConfig.imageBasePath = file;    if (currentConfig.imageBasePath !== originalConfig.imageBasePath) {      onLoading.value = true;      try {        await saveImageBasePath(currentConfig.imageBasePath);        originalConfig.imageBasePath = currentConfig.imageBasePath;        // todo 二次弹窗确认是否需要迁移旧数据      } catch (e) {        error('修改图片存储路径设置出错:' + e);        message.error(currentLanguage.value.pages.settings.saveFailedMsg);        currentConfig.imageBasePath = originalConfig.imageBasePath;      } finally {        onLoading.value = false;      }    }  }}// 加载配置onMounted(async () => {  try {    defaultPath.value = await appDataDir() + (isMac ? '/' : '\\') + 'images';    // 初始化用户配置    const maxHistoryItems = await getMaxHistoryItems();    originalConfig.maxHistoryItems = maxHistoryItems;    currentConfig.maxHistoryItems = maxHistoryItems;    const dataRetentionDays = await getDataRetentionDays();    originalConfig.dataRetentionDays = dataRetentionDays;    currentConfig.dataRetentionDays = dataRetentionDays;    const imageBasePath = await getImageBasePath();    originalConfig.imageBasePath = imageBasePath;    currentConfig.imageBasePath = imageBasePath;  } catch (e) {    console.error('页面初始化失败:', e);    error("页面初始化失败：" + e);    message.error(currentLanguage.value.pages.settings.initFailedHint);  }});</script><template>  <div class="settings-section">    <n-divider title-placement="left">{{ currentLanguage.pages.settings.storageTitle }}</n-divider>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.maxHistoryItems }}</span>        <n-input-number            class="input-number"            v-model:value="currentConfig.maxHistoryItems"            :min="0"            :max="10000"            :loading="onLoading"            :disabled="onLoading"            @blur="onChangeMaxHistoryItems"        />      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">          {{ currentLanguage.pages.settings.maxHistoryItemsHint }}          </span>        </div>      </div>    </div>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.dataRetentionDays }}</span>        <n-input-number            class="input-number"            v-model:value="currentConfig.dataRetentionDays"            :min="0"            :max="365"            :loading="onLoading"            :disabled="onLoading"            @blur="onChangeDataRetentionDays"        />      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">          {{ currentLanguage.pages.settings.dataRetentionDaysHint }}          </span>        </div>      </div>    </div>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.imageStorageLocation }}</span>        <n-input            class="file-input"            v-model:value="currentConfig.imageBasePath"            readonly        >          <template #suffix>            <select-file-icon class="select-file-icon" @click="onSelectFile"/>          </template>        </n-input>      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">            {{ currentLanguage.pages.settings.imageStorageLocationHint.replace('{path}', defaultPath) }}          </span>        </div>      </div>    </div>  </div></template><style scoped>.select-file-icon {  width: 17px;  opacity: 0.7;  cursor: pointer;  padding-left: var(--n-padding-left);  padding-right: var(--n-padding-right);}.select-file-icon:hover {  opacity: 1;}:deep(.n-input .n-input-wrapper) {  padding-right: 0;}</style>