<script setup lang="ts">import HintIcon from "../../../assets/icons/HintIcon.vue";import {currentConfig, onLoading, originalConfig} from "../composables/SettingsDataComposable.ts";import {useMessage} from "naive-ui";import {  getDataRetentionDays,  getEnableImageSave,  getImageBasePath,  getMaxHistoryItems,  saveDataRetentionDays,  saveEnableImageSave,  saveImageBasePath,  saveMaxHistoryItems} from "../../../store/Settings.ts";import {emit} from "@tauri-apps/api/event";import {error} from "@tauri-apps/plugin-log";import {onMounted, ref} from "vue";import {currentLanguage} from "../../../services/LanguageService.ts";import SelectFileIcon from "../../../assets/icons/SelectFileIcon.vue";import {open} from '@tauri-apps/plugin-dialog';import {appDataDir} from "@tauri-apps/api/path";import {isMac} from "../../../data/SystemParams.ts";import ClipboardDBService from "../../../services/ClipboardDBService.ts";import {deleteFolder, moveFile} from "../../../utils/FileUtil.ts";const message = useMessage();const defaultPath = ref('');const updateImagePathVisible = ref(false);const replaceImageItemCount = ref(0);const isUpdateImagePath = ref(false);const moveImageCount = ref(0);/** * 修改最大历史记录项数 */async function onChangeMaxHistoryItems() {  if (currentConfig.maxHistoryItems !== originalConfig.maxHistoryItems) {    onLoading.value = true;    try {      await saveMaxHistoryItems(currentConfig.maxHistoryItems);      await emit('update-data-history-restrict', {        maxHistoryItems: currentConfig.maxHistoryItems,        dataRetentionDays: currentConfig.dataRetentionDays      });      originalConfig.maxHistoryItems = currentConfig.maxHistoryItems;    } catch (e) {      error('修改最大历史记录项数设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.maxHistoryItems = originalConfig.maxHistoryItems;    } finally {      onLoading.value = false;    }  }}/** * 修改数据保留天数 */async function onChangeDataRetentionDays() {  if (currentConfig.dataRetentionDays !== originalConfig.dataRetentionDays) {    onLoading.value = true;    try {      await saveDataRetentionDays(currentConfig.dataRetentionDays);      await emit('update-data-history-restrict', {        maxHistoryItems: currentConfig.maxHistoryItems,        dataRetentionDays: currentConfig.dataRetentionDays      });      originalConfig.dataRetentionDays = currentConfig.dataRetentionDays;    } catch (e) {      error('修改数据保留天数设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.dataRetentionDays = originalConfig.dataRetentionDays;    } finally {      onLoading.value = false;    }  }}/** * 修改是否保存图片 */async function onChangeEnableImageSave() {  if (currentConfig.enableImageSave !== originalConfig.enableImageSave) {    onLoading.value = true;    try {      await saveEnableImageSave(currentConfig.enableImageSave);      originalConfig.enableImageSave = currentConfig.enableImageSave;    } catch (e) {      error('修改是否保存图片设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.enableImageSave = originalConfig.enableImageSave;    } finally {      onLoading.value = false;    }  }}/** * 选择图片存储路径 */async function onSelectFile() {  const file = await open({    multiple: false,    directory: true,    defaultPath: currentConfig.imageBasePath,    canCreateDirectories: true,  });  console.log('选择文件夹', file);  if (file) {    currentConfig.imageBasePath = file;    if (currentConfig.imageBasePath !== originalConfig.imageBasePath) {      onLoading.value = true;      try {        await saveImageBasePath(currentConfig.imageBasePath);        originalConfig.imageBasePath = currentConfig.imageBasePath;        // 二次弹窗确认是否需要迁移旧数据        const db = await ClipboardDBService.getInstance();        const items = await db.getItemCount('image');        if (items && items.length > 0) {          replaceImageItemCount.value = items[0].count;        }        if (replaceImageItemCount.value > 0) {          updateImagePathVisible.value = true;        }      } catch (e) {        error('修改图片存储路径设置出错:' + e);        message.error(currentLanguage.value.pages.settings.saveFailedMsg);        currentConfig.imageBasePath = originalConfig.imageBasePath;      } finally {        onLoading.value = false;      }    }  }}/** * 更新图片存储路径 */async function handleUpdateImagePath() {  isUpdateImagePath.value = true;  const db = await ClipboardDBService.getInstance();  const items = await db.getItems('image');  if (items && items.length > 0) {    const oldBasePaths: Set<string> = new Set<string>();    for (let item of items) {      // 获取旧文件的文件夹路径      const oldBasePath = item.file_path.substring(0, item.file_path.lastIndexOf(isMac ? '/' : '\\'));      if (!oldBasePaths.has(oldBasePath)) {        oldBasePaths.add(oldBasePath);      }      const fileName = item.file_path.substring(item.file_path.lastIndexOf(isMac ? '/' : '\\') + 1);      const filePath = currentConfig.imageBasePath + (isMac ? '/' : '\\') + fileName;      await moveFile(item.file_path, filePath);      await db.updateItemFilePath(item.id, filePath);      moveImageCount.value = moveImageCount.value + 1;    }    // 删除文件夹    for (let oldBasePath of oldBasePaths) {      await deleteFolder(oldBasePath);    }    setTimeout(() => {      updateImagePathVisible.value = false;      replaceImageItemCount.value = 0;      isUpdateImagePath.value = false;      moveImageCount.value = 0;      emit('reload-items');    }, 100);  }}// 加载配置onMounted(async () => {  try {    defaultPath.value = await appDataDir() + (isMac ? '/' : '\\') + 'images';    // 初始化用户配置    const maxHistoryItems = await getMaxHistoryItems();    originalConfig.maxHistoryItems = maxHistoryItems;    currentConfig.maxHistoryItems = maxHistoryItems;    const dataRetentionDays = await getDataRetentionDays();    originalConfig.dataRetentionDays = dataRetentionDays;    currentConfig.dataRetentionDays = dataRetentionDays;    const imageBasePath = await getImageBasePath();    originalConfig.imageBasePath = imageBasePath;    currentConfig.imageBasePath = imageBasePath;    const enableImageSave = await getEnableImageSave();    originalConfig.enableImageSave = enableImageSave;    currentConfig.enableImageSave = enableImageSave;  } catch (e) {    console.error('页面初始化失败:', e);    error("页面初始化失败：" + e);    message.error(currentLanguage.value.pages.settings.initFailedHint);  }});</script><template>  <div class="settings-section">    <n-divider title-placement="left">{{ currentLanguage.pages.settings.storageTitle }}</n-divider>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.maxHistoryItems }}</span>        <n-input-number            class="input-number"            v-model:value="currentConfig.maxHistoryItems"            :min="0"            :max="10000"            :loading="onLoading"            :disabled="onLoading"            @blur="onChangeMaxHistoryItems"        />      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">          {{ currentLanguage.pages.settings.maxHistoryItemsHint }}          </span>        </div>      </div>    </div>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.dataRetentionDays }}</span>        <n-input-number            class="input-number"            v-model:value="currentConfig.dataRetentionDays"            :min="0"            :max="365"            :loading="onLoading"            :disabled="onLoading"            @blur="onChangeDataRetentionDays"        />      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">          {{ currentLanguage.pages.settings.dataRetentionDaysHint }}          </span>        </div>      </div>    </div>    <div class="line">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.enableImageSave }}</span>        <n-switch v-model:value="currentConfig.enableImageSave"                  :loading="onLoading"                  :disabled="onLoading"                  @update:value="onChangeEnableImageSave"        />      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          <span class="hint-text">            {{ currentLanguage.pages.settings.enableImageSaveHint }}          </span>        </div>      </div>    </div>    <div class="form-item" v-if="currentConfig.enableImageSave">      <span class="label">{{ currentLanguage.pages.settings.imageStorageLocation }}</span>      <n-input          class="file-input"          v-model:value="currentConfig.imageBasePath"          readonly      >        <template #suffix>          <select-file-icon class="select-file-icon" @click="onSelectFile"/>        </template>      </n-input>    </div>    <!-- 更新文件地址弹窗 -->    <n-modal v-model:show="updateImagePathVisible"             :title="currentLanguage.pages.settings.replaceImageStorageLocationTitle"             preset="dialog">      <p v-if="!isUpdateImagePath">{{          currentLanguage.pages.settings.replaceImageStorageLocationConfirm.replace('{num}', String(replaceImageItemCount))        }}</p>      <div v-else class="replace-image-storage-location-progress">        <div class="replace-image-storage-location-text">          {{ currentLanguage.pages.settings.replaceImageStorageLocationProcessing }}        </div>        <div class="replace-image-storage-location-stat">{{ moveImageCount }} / {{ replaceImageItemCount }}</div>      </div>      <template #action v-if="!isUpdateImagePath">        <n-button @click="() => {updateImagePathVisible = false;onLoading=false;}">          {{ currentLanguage.pages.settings.replaceImageStorageLocationCancelBtn }}        </n-button>        <n-button type="primary" @click="handleUpdateImagePath">          {{ currentLanguage.pages.settings.replaceImageStorageLocationConfirmBtn }}        </n-button>      </template>    </n-modal>  </div></template><style scoped>.select-file-icon {  width: 17px;  opacity: 0.7;  cursor: pointer;  padding-left: var(--n-padding-left);  padding-right: var(--n-padding-right);}.select-file-icon:hover {  opacity: 1;}:deep(.n-input .n-input-wrapper) {  padding-right: 0;}.replace-image-storage-location-progress {  display: flex;  flex-direction: column;  align-items: center;}.replace-image-storage-location-stat {  font-size: 24px;}</style>