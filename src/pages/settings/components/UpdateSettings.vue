<script setup lang="ts">import HintIcon from "../../../assets/icons/HintIcon.vue";import {currentConfig, onLoading, originalConfig, selectedKey} from "../composables/settingsComposable.ts";import {useMessage} from "naive-ui";import {useLanguage} from "../../../services/LanguageService.ts";import {computed, onMounted} from "vue";import {  getAutoCheckUpdate,  getAutoCheckUpdateInterval,  getNewVersionAlertMode,  getUpdateMode,  saveAutoCheckUpdate,  saveAutoCheckUpdateInterval,  saveNewVersionAlertMode,  saveUpdateMode} from "../../../store/Settings.ts";import {emit} from "@tauri-apps/api/event";import {error} from "@tauri-apps/plugin-log";import {SETTINGS} from "../../../constants/UserSettingsConstant.ts";const message = useMessage();const {currentLanguage} = useLanguage();// 自动检查更新方式const autoUpdateMode = computed(() => [{  value: SETTINGS.UPDATER.CHECK_MODE.TIMING,  label: currentLanguage.value.pages.settings.regularCheck}, {  value: SETTINGS.UPDATER.CHECK_MODE.AFTER_RUNNING,  label: currentLanguage.value.pages.settings.afterRunningCheck}])// 更新提示显示方式const updateHintMode = computed(() => [{  value: SETTINGS.UPDATER.HINT_MODE.TOAST,  label: currentLanguage.value.pages.settings.toast}, {  value: SETTINGS.UPDATER.HINT_MODE.DIALOG,  label: currentLanguage.value.pages.settings.dialog}])/** * 修改自动检查更新 * @param autoCheckUpdate 是否自动检查更新 */async function onChangeAutoCheckUpdate(autoCheckUpdate: boolean) {  onLoading.value = true;  try {    await saveAutoCheckUpdate(autoCheckUpdate);    // 发送更新了自动检查更新状态消息    await emit('update-auto-check-update', {      isUpdate: currentConfig.autoCheckUpdate,      updateMode: currentConfig.updateMode,      interval: currentConfig.autoCheckUpdateInterval    });    originalConfig.autoCheckUpdate = autoCheckUpdate;    currentConfig.autoCheckUpdate = autoCheckUpdate;  } catch (e) {    error('修改自动检查更新设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.autoCheckUpdate = originalConfig.autoCheckUpdate;  } finally {    onLoading.value = false;  }}/** * 修改更新模式 * @param updateMode 更新模式 */async function onChangeUpdateMode(updateMode: string) {  onLoading.value = true;  try {    await saveUpdateMode(updateMode);    // 发送更新了自动检查更新状态消息    await emit('update-auto-check-update', {      isUpdate: currentConfig.autoCheckUpdate,      updateMode: currentConfig.updateMode,      interval: currentConfig.autoCheckUpdateInterval    });    originalConfig.updateMode = updateMode;    currentConfig.updateMode = updateMode;  } catch (e) {    error('修改更新模式设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.updateMode = originalConfig.updateMode;  } finally {    onLoading.value = false;  }}/** * 修改自动检查更新间隔 */async function onChangeAutoCheckUpdateInterval() {  if (originalConfig.autoCheckUpdateInterval !== currentConfig.autoCheckUpdateInterval) {    onLoading.value = true;    try {      await saveAutoCheckUpdateInterval(currentConfig.autoCheckUpdateInterval);      // 发送更新了自动检查更新状态消息      await emit('update-auto-check-update', {        isUpdate: currentConfig.autoCheckUpdate,        updateMode: currentConfig.updateMode,        interval: currentConfig.autoCheckUpdateInterval      });      originalConfig.autoCheckUpdateInterval = currentConfig.autoCheckUpdateInterval;    } catch (e) {      error('修改自动检查更新间隔设置出错:' + e);      message.error(currentLanguage.value.pages.settings.saveFailedMsg);      currentConfig.autoCheckUpdateInterval = originalConfig.autoCheckUpdateInterval;    } finally {      onLoading.value = false;    }  }}/** * 修改新版本提示模式 * @param newVersionAlertMode 新版本提示模式 */async function onChangeNewVersionAlertMode(newVersionAlertMode: string) {  onLoading.value = true;  try {    await saveNewVersionAlertMode(newVersionAlertMode);    // 发送更新了自动检查更新状态消息    await emit('update-auto-check-update', {      isUpdate: currentConfig.autoCheckUpdate,      updateMode: currentConfig.updateMode,      interval: currentConfig.autoCheckUpdateInterval    });    originalConfig.newVersionAlertMode = newVersionAlertMode;    currentConfig.newVersionAlertMode = newVersionAlertMode;  } catch (e) {    error('修改新版本提示模式设置出错:' + e);    message.error(currentLanguage.value.pages.settings.saveFailedMsg);    currentConfig.newVersionAlertMode = originalConfig.newVersionAlertMode;  } finally {    onLoading.value = false;  }}// 加载配置onMounted(async () => {  try {    // 初始化用户配置    const autoCheckUpdate = await getAutoCheckUpdate();    originalConfig.autoCheckUpdate = autoCheckUpdate;    currentConfig.autoCheckUpdate = autoCheckUpdate;    const updateMode = await getUpdateMode();    originalConfig.updateMode = updateMode;    currentConfig.updateMode = updateMode;    const autoCheckUpdateInterval = await getAutoCheckUpdateInterval();    originalConfig.autoCheckUpdateInterval = autoCheckUpdateInterval;    currentConfig.autoCheckUpdateInterval = autoCheckUpdateInterval;    const newVersionAlertMode = await getNewVersionAlertMode();    originalConfig.newVersionAlertMode = newVersionAlertMode;    currentConfig.newVersionAlertMode = newVersionAlertMode;  } catch (e) {    console.error('页面初始化失败:', e);    error("页面初始化失败：" + e);    message.error(currentLanguage.value.pages.settings.initFailedHint);  }});</script><template>  <!-- 更新设置 -->  <div v-if="selectedKey === 'updater'" :key="'updater'" class="settings-section">    <h2>{{ currentLanguage.pages.settings.updaterTitle }}</h2>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.autoCheckUpdate }}</span>      <n-switch v-model:value="currentConfig.autoCheckUpdate"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeAutoCheckUpdate"      />    </div>    <div class="form-item" v-if="currentConfig.autoCheckUpdate">      <span class="label">{{ currentLanguage.pages.settings.checkUpdateMode }}</span>      <n-select class="select"                v-model:value="currentConfig.updateMode"                :options="autoUpdateMode"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeUpdateMode"      />    </div>    <div class="line" v-if="currentConfig.autoCheckUpdate && currentConfig.updateMode === SETTINGS.UPDATER.CHECK_MODE.TIMING">      <div class="main-item">        <span class="label">{{ currentLanguage.pages.settings.timeInterval }}</span>        <n-input-number            class="input-number"            v-model:value="currentConfig.autoCheckUpdateInterval"            :min="1"            :max="720"            :loading="onLoading"            :disabled="onLoading"            @blur="onChangeAutoCheckUpdateInterval"        >          <template #suffix>            {{ currentLanguage.pages.settings.timeIntervalUnit }}          </template>        </n-input-number>      </div>      <div class="second-item">        <div class="hint">          <HintIcon class="hint-icon"/>          {{ currentLanguage.pages.settings.timeIntervalHint }}        </div>      </div>    </div>    <div class="form-item">      <span class="label">{{ currentLanguage.pages.settings.newVersionAlertMode }}</span>      <n-select class="select"                v-model:value="currentConfig.newVersionAlertMode"                :options="updateHintMode"                :loading="onLoading"                :disabled="onLoading"                @update:value="onChangeNewVersionAlertMode"      />    </div>  </div></template><style scoped></style>