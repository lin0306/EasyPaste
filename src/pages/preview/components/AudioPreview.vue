<script setup lang="ts">import {onMounted, onUnmounted, ref, watch} from "vue";import {convertFileSrc} from "@tauri-apps/api/core";import WaveSurfer, {WaveSurferOptions} from "wavesurfer.js";import LoopIcon from "../../../assets/icons/LoopIcon.vue";import UnLoopIcon from "../../../assets/icons/UnLoopIcon.vue";import RestartPlayerIcon from "../../../assets/icons/RestartPlayerIcon.vue";import {convertSecondsToTime} from "../../../utils/DateUtil.ts";import {currentLanguage} from "../../../services/LanguageService.ts";import {currentThemeId, themeColors} from "../../../services/ThemeService.ts";const props = defineProps<{  filePath: string}>()const isPlaying = ref(false); // 播放状态const volume = ref(0.7); // 默认音量const playbackRate = ref<number>(1.0); // 默认正常速度const currentTime = ref<number>(0); // 当前播放时间const duration = ref(0); // 音频时长const isLoading = ref(false); // 是否正在加载音频const isLoop = ref(true); // 是否循环播放// 播放速度标记const playbackRateMarks = {  0.5: '',  0.75: '',  1.0: '',  1.25: '',  1.5: '',  2.0: '',  3.0: '',  4.0: '',  5.0: '',}// Wavesurfer 实例let wavesurfer: WaveSurfer;/** * 播放/暂停 */function playPause() {  if (wavesurfer) {    wavesurfer.playPause();  }}/** * 重置播放器 */function restartPlayer() {  currentTime.value = 0;  wavesurfer.setTime(0);  if (wavesurfer.isPlaying()) {    wavesurfer.play();  }}/** * 设置音量 */function setVolume() {  if (wavesurfer) {    wavesurfer.setVolume(volume.value);  }}/** * 设置播放速度 */function setPlaybackRate() {  if (wavesurfer) {    wavesurfer.setPlaybackRate(playbackRate.value);  }}/** * 拖动进度条 */function onSeek() {  if (wavesurfer && duration.value > 0) {    const progress = currentTime.value / duration.value;    wavesurfer.seekTo(progress);  }}/** * 获取 Wavesurfer 选项 */function getWavesurferOptions() {  return {    container: '#waveformContainer',    waveColor: themeColors.value.wavesurfer.waveColor,    cursorColor: themeColors.value.wavesurfer.cursorColor,    progressColor: themeColors.value.wavesurfer.progressColor,    height: 90,    cursorWidth: 2,    barWidth: 2,    barRadius: 2,    barGap: 1,    normalize: true,    backend: 'MediaElement',    mediaControls: false, // 不显示默认的媒体控件    autoplay: false,    url: convertFileSrc(props.filePath),    interact: true, // 启用与波形的交互（点击/拖拽改变播放位置）    dragToSeek: true, // 启用拖拽 seek  } as WaveSurferOptions;}/** * 初始化 Wavesurfer */function initWavesurfer() {  isLoading.value = true;  console.log('初始化 Wavesurfer');  // 初始化 Wavesurfer 实例  wavesurfer = WaveSurfer.create(getWavesurferOptions());  // --- Wavesurfer 事件监听 ---  wavesurfer.on('ready', () => {    console.log('Wavesurfer 加载完成');    duration.value = wavesurfer.getDuration();    setVolume(); // 确保初始音量被设置    setPlaybackRate(); // 确保初始倍速被设置    isLoading.value = false;  });  wavesurfer.on('play', () => {    isPlaying.value = true;  });  wavesurfer.on('pause', () => {    isPlaying.value = false;  });  wavesurfer.on('finish', () => {    isPlaying.value = false;    currentTime.value = duration.value;    if (isLoop.value) {      wavesurfer.play();    }  });  wavesurfer.on('audioprocess', () => {    // 当音频播放时更新当前时间    if (wavesurfer.isPlaying()) {      currentTime.value = wavesurfer.getCurrentTime();    }  });  // 监听用户点击/拖拽波形改变播放位置  wavesurfer.on('interaction', (newTime) => {    currentTime.value = newTime;  });  // 监听音量变化  watch(volume, () => {    setVolume();  });  // 监听倍速变化  watch(playbackRate, () => {    setPlaybackRate();  });  // 监听主题切换  watch(currentThemeId, () => {    wavesurfer.setOptions(getWavesurferOptions());  })}/** * 监听文件路径变化 */watch(() => props.filePath, () => {  if (wavesurfer) {    isLoading.value = true;    currentTime.value = 0;    wavesurfer.setTime(0);    wavesurfer.load(convertFileSrc(props.filePath));  } else {    initWavesurfer();  }})onMounted(() => {  initWavesurfer();});onUnmounted(() => {  // 清理资源  if (wavesurfer) {    wavesurfer.destroy();  }});</script><template>  <div class="audio-container">    <div class="waveform-wrapper">      <div v-show="isLoading" class="waveform-loading">        <n-spin/>      </div>      <div v-show="!isLoading">        <!-- Wavesurfer 波形显示区域 -->        <div id="waveformContainer" class="waveform-container"></div>        <!-- 播放进度 -->        <n-slider            class="progress-slider"            :min="0"            :max="duration"            v-model:value="currentTime"            :step="1"            @update:value="onSeek"            :format-tooltip="(val:number) => {return convertSecondsToTime(val)}"        />        <div class="progress-container">          <span>{{ convertSecondsToTime(currentTime) }}</span>          <span>{{ convertSecondsToTime(duration) }}</span>        </div>      </div>    </div>    <div class="operating-container">      <div class="main-buttons">        <loop-icon v-if="isLoop" class="loop-icon" @click="isLoop = false"/>        <un-loop-icon v-else class="loop-icon" @click="isLoop = true"/>        <font-awesome-icon icon="fa-solid fa-circle-play" @click="playPause" v-if="!isPlaying" class="play-icon"/>        <font-awesome-icon icon="fa-solid fa-circle-pause" @click="playPause" v-if="isPlaying" class="pause-icon"/>        <restart-player-icon @click="restartPlayer" class="restart-player-icon"/>      </div>      <div class="second-buttons">        <!-- 倍速控制 -->        <div class="speed-control">          <span class="speed-label">            <font-awesome-icon icon="fa-solid fa-gauge-high" class="speed-icon"/>            <span>{{ currentLanguage.pages.preview.playbackRate }}{{ playbackRate + 'x' }}</span>          </span>          <n-slider              class="speed-slider"              :min="0.5"              :max="5"              v-model:value="playbackRate"              :marks="playbackRateMarks"              step="mark"              :format-tooltip="(val:number) => {return val +'x'}"          />        </div>        <div class="volume-control">          <span class="volume-label">            <font-awesome-icon icon="fa-solid fa-volume-high" class="volume-icon"                               v-if="parseInt(String(volume * 100)) > 50"/>            <font-awesome-icon icon="fa-solid fa-volume-low" class="volume-icon"                               v-else-if="parseInt(String(volume * 100)) > 0"/>            <font-awesome-icon icon="fa-solid fa-volume-off" class="volume-icon" v-else/>            <span>{{ currentLanguage.pages.preview.volume }}{{ parseInt(String(volume * 100)) + '%' }}</span>          </span>          <n-slider              class="volume-slider"              v-model:value="volume"              :step="0.01"              :min="0"              :max="1"              :format-tooltip="(val:number) => {return parseInt(String(val * 100)) + '%'}"          />        </div>      </div>    </div>  </div></template><style scoped>.audio-container {  width: 100%;  height: 100%;  display: flex;  flex-direction: column;  justify-content: space-between;}.waveform-wrapper {  width: 100%;  height: 80px;}.waveform-loading {  width: 100%;  display: flex;  align-items: center;  justify-content: center;}.waveform-container {  background-color: var(--theme-universal-secondary);  border: 2px solid var(--theme-universal-border);  padding: 8px;  border-radius: 8px;}.progress-slider {  margin-top: 10px;  margin-bottom: 5px;}.progress-container {  width: 98%;  display: flex;  justify-content: space-between;  padding: 0 1%;}.operating-container {  display: flex;  flex-direction: column;  align-items: center;}.main-buttons {  height: 65px;  display: flex;  align-items: center;}.play-icon,.pause-icon,.loop-icon,.restart-player-icon {  margin-left: 10px;  margin-right: 10px;}.play-icon,.pause-icon {  width: 55px;  height: 55px;  opacity: 0.6;}.loop-icon {  width: 30px;  opacity: 0.6;}.restart-player-icon {  width: 27px;  opacity: 0.6;}.play-icon:hover,.pause-icon:hover,.restart-player-icon:hover,.loop-icon:hover {  opacity: 1;}.second-buttons {  width: 94%;  display: flex;  gap: 15px;  border: 2px solid var(--theme-universal-border);  border-radius: 5px;  padding: 10px 3%;}.speed-control,.volume-control {  width: 50%;  display: flex;  flex-direction: column;  align-items: center;}.speed-label,.volume-label {  display: flex;  align-items: center;  justify-content: center;  gap: 4px;  width: 100%;}.speed-icon,.volume-icon {  width: 17px;  height: 17px;}.speed-slider {  margin: auto;}</style>