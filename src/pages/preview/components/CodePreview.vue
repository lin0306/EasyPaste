<script setup lang="ts">import {nextTick, onMounted, reactive, ref, watch} from "vue";import {convertFileSize, getFileSize, readFileData} from "../../../utils/FileUtil.ts";import FileToBigIcon from "../../../assets/icons/FileToBigIcon.vue";import {getCodeLanguage, getCodeType} from "../../../utils/CodeUtil.ts";import SearchIcon from "../../../assets/icons/SearchIcon.vue";import {NIcon, NInput} from "naive-ui";import ArrowIcon from "../../../assets/icons/ArrowIcon.vue";import hljs from "highlight.js/lib/core";import c from "highlight.js/lib/languages/c";import cpp from "highlight.js/lib/languages/cpp";import java from "highlight.js/lib/languages/java";import python from "highlight.js/lib/languages/python";import go from "highlight.js/lib/languages/go";import rust from "highlight.js/lib/languages/rust";import kotlin from "highlight.js/lib/languages/kotlin";import scala from "highlight.js/lib/languages/scala";import swift from "highlight.js/lib/languages/swift";import cs from "highlight.js/lib/languages/csharp";import html from "highlight.js/lib/languages/vbscript-html";import css from "highlight.js/lib/languages/css";import javascript from "highlight.js/lib/languages/javascript";import typescript from "highlight.js/lib/languages/typescript";import php from "highlight.js/lib/languages/php";import bash from "highlight.js/lib/languages/bash";import perl from "highlight.js/lib/languages/perl";import ruby from "highlight.js/lib/languages/ruby";import lua from "highlight.js/lib/languages/lua";import r from "highlight.js/lib/languages/r";import json from "highlight.js/lib/languages/json";import xml from "highlight.js/lib/languages/xml";import yaml from "highlight.js/lib/languages/yaml";import ini from "highlight.js/lib/languages/ini";import makefile from "highlight.js/lib/languages/makefile";import cmake from "highlight.js/lib/languages/cmake";import gradle from "highlight.js/lib/languages/gradle";import sql from "highlight.js/lib/languages/sql";import dos from "highlight.js/lib/languages/dos";import nsis from "highlight.js/lib/languages/nsis";import vbscript from "highlight.js/lib/languages/vbscript";hljs.registerLanguage('c', c)hljs.registerLanguage('cpp', cpp)hljs.registerLanguage('cc', cpp)hljs.registerLanguage('cxx', cpp)hljs.registerLanguage('h', cpp)hljs.registerLanguage('hpp', cpp)hljs.registerLanguage('java', java)hljs.registerLanguage('jsp', java)hljs.registerLanguage('python', python)hljs.registerLanguage('go', go)hljs.registerLanguage('golang', go)hljs.registerLanguage('rs', rust)hljs.registerLanguage('kt', kotlin)hljs.registerLanguage('kts', kotlin)hljs.registerLanguage('scala', scala)hljs.registerLanguage('swift', swift)hljs.registerLanguage('cs', cs)hljs.registerLanguage('html', html)hljs.registerLanguage('htm', html)hljs.registerLanguage('css', css)hljs.registerLanguage('js', javascript)hljs.registerLanguage('jsx', javascript)hljs.registerLanguage('ts', typescript)hljs.registerLanguage('tsx', typescript)hljs.registerLanguage('php', php)hljs.registerLanguage('sh', bash)hljs.registerLanguage('bash', bash)hljs.registerLanguage('pl', perl)hljs.registerLanguage('rb', ruby)hljs.registerLanguage('lua', lua)hljs.registerLanguage('r', r)hljs.registerLanguage('json', json)hljs.registerLanguage('xml', xml)hljs.registerLanguage('yaml', yaml)hljs.registerLanguage('yml', yaml)hljs.registerLanguage('ini', ini)hljs.registerLanguage('toml', ini)hljs.registerLanguage('makefile', makefile)hljs.registerLanguage('mk', makefile)hljs.registerLanguage('mak', makefile)hljs.registerLanguage('make', makefile)hljs.registerLanguage('cmake', cmake)hljs.registerLanguage('gradle', gradle)hljs.registerLanguage('sql', sql)hljs.registerLanguage('dos', dos)hljs.registerLanguage('bat', dos)hljs.registerLanguage('cmd', dos)hljs.registerLanguage('nsh', nsis)hljs.registerLanguage('nsis', nsis)hljs.registerLanguage('vbs', vbscript)hljs.registerLanguage('vbscript', vbscript)const props = defineProps<{  filePath: string}>();// 文件信息const fileData = reactive({  canPreview: false,    // 是否可预览  size: '0B',           // 文件大小  type: '',             // 文件类型  content: '',          // 文件内容  originalContent: '',  // 原始文件内容  language: '',         // 文件语言});const searchText = ref(''); // 搜索关键字const matches = ref<number[]>([]); // 存储匹配项的索引const currentMatchIndex = ref(-1); // 当前匹配项的索引const codeRef = ref();const originalHighlightedHtml = ref(''); // 保存原始的高亮HTML内容const isCodeReady = ref(false); // 标记代码是否已准备好/** * 加载文件信息 */async function loadFileInfo() {  const size = await getFileSize(props.filePath);  fileData.size = convertFileSize(size);  fileData.canPreview = size < 1024 * 1024 * 2;  if (fileData.canPreview) {    fileData.type = getCodeType(props.filePath);    fileData.language = getCodeLanguage(props.filePath);    fileData.content = await readFileData(props.filePath);    fileData.originalContent = fileData.content;    // 等待DOM更新    await nextTick();    // 保存原始高亮内容    const codeElement = codeRef.value?.$el?.querySelector('.__code__');    if (codeElement) {      originalHighlightedHtml.value = codeElement.innerHTML;      console.log('原始高亮HTML内容已保存');      isCodeReady.value = true;    }  }}// 搜索功能const performSearch = () => {  if (!searchText.value) {    matches.value = [];    currentMatchIndex.value = -1;    restoreOriginalHighlight();    return;  }  // 如果代码还没准备好，等待一下  if (!isCodeReady.value) {    setTimeout(performSearch, 100);    return;  }  const text = fileData.content;  const query = searchText.value;  matches.value = [];  let index = text.indexOf(query);  while (index !== -1) {    matches.value.push(index);    index = text.indexOf(query, index + 1);  }  if (matches.value.length > 0) {    currentMatchIndex.value = 0;    highlightMatches();    scrollToCurrentMatch();  } else {    currentMatchIndex.value = -1;    restoreOriginalHighlight();  }};// 高亮匹配项 - 修复版本const highlightMatches = () => {  if (!codeRef.value || matches.value.length === 0) return;  const codeElement = codeRef.value.$el.querySelector('.__code__');  if (!codeElement) return;  const parser = new DOMParser();  const doc = parser.parseFromString(originalHighlightedHtml.value, 'text/html');  const container = doc.body;  // 递归函数替换所有文本节点  let cycleIndex = 0;  const regExp = new RegExp("(" + searchText.value + ")", 'g');  function walkAndReplace(node: Node) {    if (node.nodeType === Node.TEXT_NODE) {      const textContent = node.textContent || '';      // 检查是否包含匹配项      if (regExp.test(textContent)) {        // 重置 lastIndex（重要！避免 test 影响 split）        regExp.lastIndex = 0;        const parts = textContent.split(regExp);        const fragment = document.createDocumentFragment();        parts.forEach(part => {          if (part.length === 0) return;          if (part.toLowerCase() === searchText.value.toLowerCase()) {            const span = document.createElement('span');            span.className = cycleIndex === currentMatchIndex.value ? 'current-match' : 'other-match';            cycleIndex++;            span.textContent = part;            fragment.appendChild(span);          } else {            fragment.appendChild(document.createTextNode(part));          }        });        // ✅ 关键：用 fragment 替换当前文本节点        try {          node.replaceWith(fragment);        } catch (e) {          // 兼容旧浏览器          const parent = node.parentNode;          if (parent) {            parent.replaceChild(fragment, node);          }        }      }    } else {      Array.from(node.childNodes).forEach(walkAndReplace);    }  }  walkAndReplace(container);  // 更新代码显示  codeElement.innerHTML = container.innerHTML;};// 恢复原始高亮const restoreOriginalHighlight = () => {  if (!codeRef.value || !originalHighlightedHtml.value) return;  const codeElement = codeRef.value.$el.querySelector('.__code__');  if (codeElement) {    codeElement.innerHTML = originalHighlightedHtml.value;  }};// 滚动到当前匹配项const scrollToCurrentMatch = () => {  if (currentMatchIndex.value === -1) return;  nextTick(() => {    const currentHighlight = codeRef.value?.$el?.querySelector('.current-match');    if (currentHighlight) {      currentHighlight.scrollIntoView({behavior: 'smooth', block: 'center'});    }  });};// 导航到下一个匹配项const nextMatch = () => {  if (matches.value.length === 0) return;  currentMatchIndex.value = (currentMatchIndex.value + 1) % matches.value.length;  highlightMatches();  scrollToCurrentMatch();};// 导航到上一个匹配项const prevMatch = () => {  if (matches.value.length === 0) return;  currentMatchIndex.value = (currentMatchIndex.value - 1 + matches.value.length) % matches.value.length;  highlightMatches();  scrollToCurrentMatch();};/** * 监听文件路径变化 */watch(() => props.filePath, () => {  isCodeReady.value = false;  loadFileInfo();})onMounted(() => {  loadFileInfo();})</script><template>  <div class="code-container" v-if="fileData.canPreview">    <div class="code-header">      <n-input          id="search-input"          v-model:value="searchText"          :placeholder="`输入关键词进行搜索`"          @input="performSearch"          size="small"          key="search-input"          class="search-input"      >        <template #prefix>          <n-icon size="18">            <SearchIcon/>          </n-icon>        </template>        <template #suffix v-if="searchText.length > 0">          <span v-if="matches.length > 0">{{ currentMatchIndex + 1 }} / {{ matches.length }}</span>          <span v-else class="">0 个结果</span>        </template>      </n-input>      <arrow-icon class="down-arrow-icon"                  :class="{'arrow-icon-disable': currentMatchIndex >= matches.length - 1}"                  v-if="searchText.length > 0"                  @click="nextMatch"      />      <arrow-icon class="up-arrow-icon"                  :class="{'arrow-icon-disable': currentMatchIndex <= 0}"                  v-if="searchText.length > 0"                  @click="prevMatch"      />    </div>    <div class="code-content">      <n-code ref="codeRef" :language="fileData.language" :code="fileData.content" show-line-numbers word-wrap/>    </div>  </div>  <div v-else class="file-to-big-container">    <file-to-big-icon class="file-to-big-icon"/>    <span class="file-to-big-text">      文件大小超过 2M，暂不支持预览，请点击右上角打开文件所在位置进行浏览    </span>  </div>  <div class="file-info">    <div>文件大小：{{ fileData.size }}</div>    <div>文件语言：{{ fileData.type }}</div>  </div></template><style scoped>.file-info {  display: flex;  justify-content: space-between;}.code-container {  width: 99%;  height: 95%;  display: flex;  flex-direction: column;}.code-header {  width: 100%;  display: flex;  justify-content: flex-start;  align-items: center;  gap: 8px;}.search-input {  width: 40%;  margin: 4px 0;}.up-arrow-icon,.down-arrow-icon {  cursor: pointer;  width: 16px;  opacity: 0.6;}.up-arrow-icon {  transform: rotate(90deg);}.down-arrow-icon {  transform: rotate(-90deg);}.up-arrow-icon:hover,.down-arrow-icon:hover {  opacity: 1;}.arrow-icon-disable {  cursor: not-allowed;  opacity: 0.2 !important;}.code-content {  width: 100%;  height: 100%;  overflow: auto;  border: 3px solid var(--theme-border);  border-radius: 5px;}.code-content::-webkit-scrollbar {  border-radius: 10px;  height: 6px;}:deep(.current-match) {  background-color: #ffeb3b !important;  transition: background-color 0.3s ease;  border: 1px solid #000000;  padding: 0 2px;  border-radius: 2px;}:deep(.other-match) {  background-color: #ffe8d6;  color: #818181;  padding: 0 2px;  border-radius: 2px;}.file-to-big-container {  width: 100%;  height: 95%;  display: flex;  flex-direction: column;  justify-content: center;  align-items: center;}.file-to-big-icon {  width: 40%;  height: auto;  opacity: 0.8;}.file-to-big-text {  width: 70%;  text-align: center;  font-size: 16px;  opacity: 0.8;}</style>