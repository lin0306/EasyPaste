<script setup lang="ts">import {nextTick, onMounted, reactive, ref, watch} from "vue";import {getFileSize} from "../../../utils/FileUtil.ts";import FileToBigPreview from "../../../assets/icons/FileToBigPreview.vue";import {getCodeLanguage} from "../../../utils/CodeUtil.ts";import SearchIcon from "../../../assets/icons/SearchIcon.vue";import {NIcon, NInput} from "naive-ui";import ArrowIcon from "../../../assets/icons/ArrowIcon.vue";import hljs from "highlight.js/lib/core";import c from "highlight.js/lib/languages/c";import cpp from "highlight.js/lib/languages/cpp";import java from "highlight.js/lib/languages/java";import python from "highlight.js/lib/languages/python";import go from "highlight.js/lib/languages/go";import rust from "highlight.js/lib/languages/rust";import kotlin from "highlight.js/lib/languages/kotlin";import scala from "highlight.js/lib/languages/scala";import swift from "highlight.js/lib/languages/swift";import cs from "highlight.js/lib/languages/csharp";import html from "highlight.js/lib/languages/vbscript-html";import css from "highlight.js/lib/languages/css";import javascript from "highlight.js/lib/languages/javascript";import typescript from "highlight.js/lib/languages/typescript";import php from "highlight.js/lib/languages/php";import bash from "highlight.js/lib/languages/bash";import perl from "highlight.js/lib/languages/perl";import ruby from "highlight.js/lib/languages/ruby";import lua from "highlight.js/lib/languages/lua";import r from "highlight.js/lib/languages/r";import json from "highlight.js/lib/languages/json";import xml from "highlight.js/lib/languages/xml";import yaml from "highlight.js/lib/languages/yaml";import ini from "highlight.js/lib/languages/ini";import makefile from "highlight.js/lib/languages/makefile";import cmake from "highlight.js/lib/languages/cmake";import gradle from "highlight.js/lib/languages/gradle";import sql from "highlight.js/lib/languages/sql";import dos from "highlight.js/lib/languages/dos";import nsis from "highlight.js/lib/languages/nsis";import vbscript from "highlight.js/lib/languages/vbscript";import CASLetterIcon from "../../../assets/icons/CASLetterIcon.vue";import {readTextFile} from "@tauri-apps/plugin-fs";import {useLanguage} from "../../../services/LanguageService.ts";hljs.registerLanguage('c', c)hljs.registerLanguage('cpp', cpp)hljs.registerLanguage('cc', cpp)hljs.registerLanguage('cxx', cpp)hljs.registerLanguage('h', cpp)hljs.registerLanguage('hpp', cpp)hljs.registerLanguage('java', java)hljs.registerLanguage('jsp', java)hljs.registerLanguage('python', python)hljs.registerLanguage('go', go)hljs.registerLanguage('golang', go)hljs.registerLanguage('rs', rust)hljs.registerLanguage('kt', kotlin)hljs.registerLanguage('kts', kotlin)hljs.registerLanguage('scala', scala)hljs.registerLanguage('swift', swift)hljs.registerLanguage('cs', cs)hljs.registerLanguage('html', html)hljs.registerLanguage('htm', html)hljs.registerLanguage('css', css)hljs.registerLanguage('js', javascript)hljs.registerLanguage('jsx', javascript)hljs.registerLanguage('ts', typescript)hljs.registerLanguage('tsx', typescript)hljs.registerLanguage('php', php)hljs.registerLanguage('sh', bash)hljs.registerLanguage('bash', bash)hljs.registerLanguage('pl', perl)hljs.registerLanguage('rb', ruby)hljs.registerLanguage('lua', lua)hljs.registerLanguage('r', r)hljs.registerLanguage('json', json)hljs.registerLanguage('xml', xml)hljs.registerLanguage('yaml', yaml)hljs.registerLanguage('yml', yaml)hljs.registerLanguage('ini', ini)hljs.registerLanguage('toml', ini)hljs.registerLanguage('makefile', makefile)hljs.registerLanguage('mk', makefile)hljs.registerLanguage('mak', makefile)hljs.registerLanguage('make', makefile)hljs.registerLanguage('cmake', cmake)hljs.registerLanguage('gradle', gradle)hljs.registerLanguage('sql', sql)hljs.registerLanguage('dos', dos)hljs.registerLanguage('bat', dos)hljs.registerLanguage('cmd', dos)hljs.registerLanguage('nsh', nsis)hljs.registerLanguage('nsis', nsis)hljs.registerLanguage('vbs', vbscript)hljs.registerLanguage('vbscript', vbscript)const {currentLanguage} = useLanguage();const props = defineProps<{  filePath: string}>();// 文件信息const fileData = reactive({  canPreview: false,    // 是否可预览  content: '',          // 文件内容  originalContent: '',  // 原始文件内容  language: '',         // 文件语言});const searchText = ref(''); // 搜索关键字const matchQuantity = ref<number>(0); // 存储匹配的数量const currentMatchIndex = ref(-1); // 当前匹配项的索引const codeRef = ref();const originalHighlightedHtml = ref(''); // 保存原始的高亮HTML内容const ignoreCase = ref(false); // 是否忽略大小写/** * 加载文件信息 */async function loadFileInfo() {  const size = await getFileSize(props.filePath);  fileData.canPreview = size < 1024 * 1024 * 10;  if (fileData.canPreview) {    fileData.language = getCodeLanguage(props.filePath);    fileData.content = await readTextFile(props.filePath);    fileData.originalContent = fileData.content;    // 等待DOM更新    await nextTick();    // 保存原始高亮内容    const codeElement = codeRef.value?.$el?.querySelector('.__code__');    if (codeElement) {      originalHighlightedHtml.value = codeElement.innerHTML;      console.log('原始高亮HTML内容已保存');    }  }}/** * 更新忽略大小写，重新进行筛选 */function updateIgnoreCaseAndSearch() {  ignoreCase.value = !ignoreCase.value;  restoreOriginalHighlight();  performSearch();}// 搜索功能const performSearch = () => {  console.log('开始搜索', ignoreCase.value, searchText.value)  if (!searchText.value) {    matchQuantity.value = 0;    currentMatchIndex.value = -1;    ignoreCase.value = false;    restoreOriginalHighlight();    return;  }  const text = fileData.content;  matchQuantity.value = 0;  let regExp: RegExp;  if (ignoreCase.value) {    regExp = new RegExp("(" + searchText.value + ")", 'gi');  } else {    regExp = new RegExp("(" + searchText.value + ")", 'g');  }  const match = text.match(regExp);  console.log(match)  matchQuantity.value = match ? match.length : 0;  if (matchQuantity.value > 0) {    currentMatchIndex.value = 0;    highlightMatches();    scrollToCurrentMatch();  } else {    currentMatchIndex.value = -1;    restoreOriginalHighlight();  }};// 高亮匹配项 - 修复版本const highlightMatches = () => {  if (!codeRef.value || matchQuantity.value === 0) return;  const codeElement = codeRef.value.$el.querySelector('.__code__');  if (!codeElement) return;  const parser = new DOMParser();  const doc = parser.parseFromString(originalHighlightedHtml.value, 'text/html');  const container = doc.body;  // 递归函数替换所有文本节点  let cycleIndex = 0;  let regExp: RegExp;  if (ignoreCase.value === true) {    regExp = new RegExp("(" + searchText.value + ")", 'gi');  } else {    regExp = new RegExp("(" + searchText.value + ")", 'g');  }  function walkAndReplace(node: Node) {    if (node.nodeType === Node.TEXT_NODE) {      const textContent = node.textContent || '';      // 检查是否包含匹配项      if (regExp.test(textContent)) {        // 重置 lastIndex（重要！避免 test 影响 split）        regExp.lastIndex = 0;        const parts = textContent.split(regExp);        const fragment = document.createDocumentFragment();        parts.forEach(part => {          if (part.length === 0) return;          if (part.toLowerCase() === searchText.value.toLowerCase()) {            const span = document.createElement('span');            span.className = cycleIndex === currentMatchIndex.value ? 'current-match' : 'other-match';            cycleIndex++;            span.textContent = part;            fragment.appendChild(span);          } else {            fragment.appendChild(document.createTextNode(part));          }        });        // ✅ 关键：用 fragment 替换当前文本节点        try {          node.replaceWith(fragment);        } catch (e) {          // 兼容旧浏览器          const parent = node.parentNode;          if (parent) {            parent.replaceChild(fragment, node);          }        }      }    } else {      Array.from(node.childNodes).forEach(walkAndReplace);    }  }  walkAndReplace(container);  // 更新代码显示  codeElement.innerHTML = container.innerHTML;};// 恢复原始高亮const restoreOriginalHighlight = () => {  if (!codeRef.value || !originalHighlightedHtml.value) return;  const codeElement = codeRef.value.$el.querySelector('.__code__');  if (codeElement) {    codeElement.innerHTML = originalHighlightedHtml.value;    console.log('已恢复原始高亮')  }};// 滚动到当前匹配项const scrollToCurrentMatch = () => {  if (currentMatchIndex.value === -1) return;  nextTick(() => {    const currentHighlight = codeRef.value?.$el?.querySelector('.current-match');    if (currentHighlight) {      currentHighlight.scrollIntoView({behavior: 'smooth', block: 'center'});    }  });};// 导航到下一个匹配项const nextMatch = () => {  if (matchQuantity.value === 0) return;  if (currentMatchIndex.value >= matchQuantity.value - 1) return;  currentMatchIndex.value = (currentMatchIndex.value + 1) % matchQuantity.value;  highlightMatches();  scrollToCurrentMatch();};// 导航到上一个匹配项const prevMatch = () => {  if (matchQuantity.value === 0) return;  if (currentMatchIndex.value <= 0) return;  currentMatchIndex.value = (currentMatchIndex.value - 1 + matchQuantity.value) % matchQuantity.value;  highlightMatches();  scrollToCurrentMatch();};/** * 监听文件路径变化 */watch(() => props.filePath, () => {  loadFileInfo();})onMounted(() => {  loadFileInfo();})</script><template>  <div class="code-container" v-if="fileData.canPreview">    <div class="code-header">      <n-input          id="search-input"          v-model:value="searchText"          :placeholder="currentLanguage.pages.preview.searchPlaceholder"          @input="performSearch"          size="small"          key="search-input"          class="search-input"      >        <template #prefix>          <n-icon size="18">            <SearchIcon/>          </n-icon>        </template>        <template #suffix v-if="searchText.length > 0">          <span v-if="matchQuantity > 0">{{ currentMatchIndex + 1 }} / {{ matchQuantity }}</span>          <span v-else class="">0 / 0</span>        </template>      </n-input>      <c-a-s-letter-icon          class="cas-letter-icon"          :class="{'select': ignoreCase}"          v-if="searchText.length > 0"          @click="updateIgnoreCaseAndSearch"      />      <arrow-icon          class="down-arrow-icon"          :class="{'arrow-icon-disable': currentMatchIndex >= matchQuantity - 1}"          v-if="searchText.length > 0"          @click="nextMatch"      />      <arrow-icon          class="up-arrow-icon"          :class="{'arrow-icon-disable': currentMatchIndex <= 0}"          v-if="searchText.length > 0"          @click="prevMatch"      />    </div>    <div class="code-content">      <n-code ref="codeRef" :language="fileData.language" :code="fileData.content" show-line-numbers word-wrap/>    </div>  </div>  <div v-else class="no-preview-container">    <file-to-big-preview class="no-preview-icon"/>    <span class="no-preview-text">      {{ currentLanguage.pages.preview.cannotPreviewText }}    </span>  </div></template><style scoped>.code-container {  width: 99%;  height: 100%;  display: flex;  flex-direction: column;}.code-header {  width: 100%;  display: flex;  justify-content: flex-start;  align-items: center;  gap: 8px;}.search-input {  width: 40%;  margin: 4px 0;}.cas-letter-icon,.up-arrow-icon,.down-arrow-icon {  cursor: pointer;  width: 16px;  height: 16px;  padding: 4px;  opacity: 0.6;  border-radius: 4px;}.up-arrow-icon {  transform: rotate(90deg);}.down-arrow-icon {  transform: rotate(-90deg);}.cas-letter-icon:hover,.up-arrow-icon:hover,.down-arrow-icon:hover {  opacity: 1;}.cas-letter-icon.select {  opacity: 1;  background-color: var(--theme-border);}.arrow-icon-disable {  cursor: not-allowed;  opacity: 0.2 !important;}.code-content {  width: 100%;  height: 100%;  overflow: auto;  border: 3px solid var(--theme-border);  border-radius: 5px;}.code-content::-webkit-scrollbar {  border-radius: 10px;  height: 6px;}:deep(.current-match) {  background-color: #ffeb3b !important;  transition: background-color 0.3s ease;  border: 1px solid #000000;  padding: 0 2px;  border-radius: 2px;}:deep(.other-match) {  background-color: #ffe8d6;  color: #818181;  padding: 0 2px;  border-radius: 2px;}</style>