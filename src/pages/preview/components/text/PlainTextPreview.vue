<script setup lang="ts">import {nextTick, onMounted, reactive, ref, watch} from "vue";import SearchIcon from "../../../../assets/icons/SearchIcon.vue";import {NIcon, NInput} from "naive-ui";import ArrowIcon from "../../../../assets/icons/ArrowIcon.vue";import CASLetterIcon from "../../../../assets/icons/CASLetterIcon.vue";import {readTextFile} from "@tauri-apps/plugin-fs";import {useLanguage} from "../../../../services/LanguageService.ts";const {currentLanguage} = useLanguage();const props = defineProps<{  filePath: string}>();// 文件信息const fileData = reactive({  content: '',          // 文件内容  originalContent: '',  // 原始文件内容});const searchText = ref(''); // 搜索关键字const matchQuantity = ref<number>(0); // 存储匹配的数量const currentMatchIndex = ref(-1); // 当前匹配项的索引const codeRef = ref();const ignoreCase = ref(false); // 是否忽略大小写/** * 加载文件信息 */async function loadFileInfo() {  fileData.content = await readTextFile(props.filePath);  fileData.originalContent = fileData.content;}/** * 更新忽略大小写，重新进行筛选 */function updateIgnoreCaseAndSearch() {  ignoreCase.value = !ignoreCase.value;  fileData.content = fileData.originalContent;  performSearch();}// 搜索功能const performSearch = () => {  console.log('开始搜索', ignoreCase.value, searchText.value)  if (!searchText.value) {    matchQuantity.value = 0;    currentMatchIndex.value = -1;    ignoreCase.value = false;    fileData.content = fileData.originalContent;    return;  }  const text = fileData.content;  matchQuantity.value = 0;  let regExp: RegExp;  if (ignoreCase.value) {    regExp = new RegExp("(" + searchText.value + ")", 'gi');  } else {    regExp = new RegExp("(" + searchText.value + ")", 'g');  }  const match = text.match(regExp);  console.log(match)  matchQuantity.value = match ? match.length : 0;  if (matchQuantity.value > 0) {    currentMatchIndex.value = 0;    highlightMatches();    scrollToCurrentMatch();  } else {    currentMatchIndex.value = -1;    fileData.content = fileData.originalContent;  }};// 高亮匹配项const highlightMatches = () => {  if (matchQuantity.value === 0) return;  // 递归函数替换所有文本节点  let cycleIndex = 0;  let regExp: RegExp;  if (ignoreCase.value === true) {    regExp = new RegExp("(" + searchText.value + ")", 'gi');  } else {    regExp = new RegExp("(" + searchText.value + ")", 'g');  }  let content = "";  const textContent = fileData.originalContent;  // 检查是否包含匹配项  if (regExp.test(textContent)) {    // 重置 lastIndex（重要！避免 test 影响 split）    regExp.lastIndex = 0;    const parts = textContent.split(regExp);    parts.forEach(part => {      if (part.length === 0) return;      if (part.toLowerCase() === searchText.value.toLowerCase()) {        const span = `<span class="${cycleIndex === currentMatchIndex.value ? 'current-match' : 'other-match'}">${part}</span>`;        content += span;        cycleIndex++;      } else {        content += part;      }    });  } else {    content = fileData.originalContent;  }  // 更新代码显示  fileData.content = content;};// 滚动到当前匹配项const scrollToCurrentMatch = () => {  if (currentMatchIndex.value === -1) return;  nextTick(() => {    const currentHighlight = codeRef.value?.$el?.querySelector('.current-match');    if (currentHighlight) {      currentHighlight.scrollIntoView({behavior: 'smooth', block: 'center'});    }  });};// 导航到下一个匹配项const nextMatch = () => {  if (matchQuantity.value === 0) return;  if (currentMatchIndex.value >= matchQuantity.value - 1) return;  currentMatchIndex.value = (currentMatchIndex.value + 1) % matchQuantity.value;  highlightMatches();  scrollToCurrentMatch();};// 导航到上一个匹配项const prevMatch = () => {  if (matchQuantity.value === 0) return;  if (currentMatchIndex.value <= 0) return;  currentMatchIndex.value = (currentMatchIndex.value - 1 + matchQuantity.value) % matchQuantity.value;  highlightMatches();  scrollToCurrentMatch();};/** * 监听文件路径变化 */watch(() => props.filePath, () => {  loadFileInfo();})onMounted(() => {  loadFileInfo();})</script><template>  <div class="text-container">    <div class="text-header">      <n-input          id="search-input"          v-model:value="searchText"          :placeholder="currentLanguage.pages.preview.searchPlaceholder"          @input="performSearch"          size="small"          key="search-input"          class="search-input"      >        <template #prefix>          <n-icon size="18">            <SearchIcon/>          </n-icon>        </template>        <template #suffix v-if="searchText.length > 0">          <span v-if="matchQuantity > 0">{{ currentMatchIndex + 1 }} / {{ matchQuantity }}</span>          <span v-else class="">0 / 0</span>        </template>      </n-input>      <c-a-s-letter-icon          class="cas-letter-icon"          :class="{'select': ignoreCase}"          v-if="searchText.length > 0"          @click="updateIgnoreCaseAndSearch"      />      <arrow-icon          class="down-arrow-icon"          :class="{'arrow-icon-disable': currentMatchIndex >= matchQuantity - 1}"          v-if="searchText.length > 0"          @click="nextMatch"      />      <arrow-icon          class="up-arrow-icon"          :class="{'arrow-icon-disable': currentMatchIndex <= 0}"          v-if="searchText.length > 0"          @click="prevMatch"      />    </div>    <div class="text-content" v-html="fileData.content">    </div>  </div></template><style scoped>.text-container {  width: 99%;  height: 100%;  display: flex;  flex-direction: column;}.text-header {  width: 100%;  display: flex;  justify-content: flex-start;  align-items: center;  gap: 8px;}.search-input {  width: 40%;  margin: 4px 0;}.cas-letter-icon,.up-arrow-icon,.down-arrow-icon {  cursor: pointer;  width: 16px;  height: 16px;  padding: 4px;  opacity: 0.6;  border-radius: 4px;}.up-arrow-icon {  transform: rotate(90deg);}.down-arrow-icon {  transform: rotate(-90deg);}.cas-letter-icon:hover,.up-arrow-icon:hover,.down-arrow-icon:hover {  opacity: 1;}.cas-letter-icon.select {  opacity: 1;  background-color: var(--theme-border);}.arrow-icon-disable {  cursor: not-allowed;  opacity: 0.2 !important;}.text-content {  width: 100%;  height: 100%;  overflow: auto;  border: 3px solid var(--theme-border);  border-radius: 5px;  white-space: pre-wrap;}:deep(.current-match) {  background-color: #ffeb3b !important;  transition: background-color 0.3s ease;  border: 1px solid #000000;  padding: 0 2px;  border-radius: 2px;}:deep(.other-match) {  background-color: #ffe8d6;  color: #818181;  padding: 0 2px;  border-radius: 2px;}</style>