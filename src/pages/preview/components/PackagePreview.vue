<script setup lang="ts">import {h, onMounted, reactive, ref, watch} from 'vue';import {convertFileSize, getFileSize} from "../../../utils/FileUtil.ts";import {convertChildren, getType, readZipData} from "../../../utils/PackageUtil.ts";import FileToBigIcon from "../../../assets/icons/FileToBigIcon.vue";import {NGradientText, useMessage} from "naive-ui";import {readFile} from "@tauri-apps/plugin-fs";import {filePathConvertFileName} from "../../../utils/strUtil.ts";import {PackageTreeOption} from "../../../types/PackageTreeOption";import EncryptedIcon from "../../../assets/icons/EncryptedIcon.vue";import {Uint8ArrayReader, ZipReader} from "@zip.js/zip.js";import {updatePrefixWithExpanded} from "../../../utils/TreeUtil.ts";import CloseFolderIcon from "../../../assets/icons/CloseFolderIcon.vue";import {invoke} from "@tauri-apps/api/core";const message = useMessage();const props = defineProps<{  filePath: string}>()// 文件信息const fileData = reactive({  canPreview: false,              // 是否可预览  size: '0B',                     // 文件大小  type: '',                       // 文件类型  password: '',                   // 密码  isEncrypt: false,               // 是否加密  isLoadingFile: true,            // 是否加载成功  content: new Uint8Array(0),     // 文件数据  showPasswordModel: false,       // 是否显示输入密码弹窗  onUncompressLoading: false,     // 是否正在加载中});const folderTree = ref<PackageTreeOption[]>();async function loadFileInfo() {  fileData.isLoadingFile = true;  const size = await getFileSize(props.filePath);  fileData.size = convertFileSize(size);  fileData.canPreview = size < 1024 * 1024 * 1024;  fileData.type = getType(props.filePath);  if (fileData.canPreview) {    // 解压文件内容    await onUncompressing(false);  }  fileData.isLoadingFile = false;}/** * 文件解压缩 */async function onUncompressing(isLoading: boolean = true) {  fileData.onUncompressLoading = isLoading;  // 解压 ZIP  if (fileData.type === 'application/zip' && await onUncompressZIP()) {    fileData.showPasswordModel = false;    return;  }  // 解压 RAR  if (fileData.type === 'application/x-rar-compressed' && await onUncompressRAR()) {    fileData.showPasswordModel = false;    return;  }  // 解压 TAR  if (fileData.type === 'application/x-tar' && await onUncompressTAR()) {    fileData.showPasswordModel = false;    return;  }  // 解压 GZIP  if (fileData.type === 'application/gzip' && await onUncompressGZIP()) {    fileData.showPasswordModel = false;    return;  }  // todo 解压 7ZIP  if (fileData.type === 'application/x-7z-compressed') {    fileData.showPasswordModel = false;    return;  }  if (fileData.password) {    message.error("密码错误");  }  if (isLoading) {    setTimeout(() => fileData.onUncompressLoading = false, 500);  }}/** * 解析 ZIP */async function onUncompressZIP() {  fileData.content = await readFile(props.filePath);  let content;  // 创建 ZipReader 实例  const reader = new ZipReader(new Uint8ArrayReader(fileData.content));  try {    // 获取 ZIP 中的所有条目（文件）    const entries = await reader.getEntries();    console.log('ZIP 文件条目：', entries)    // 读取zip文件内容    content = await readZipData(entries);  } catch (err: any) {    console.error('解压失败:', err);    message.error("文件解压缩失败，错误原因：" + err.message);    return false;  } finally {    // 关闭 reader    await reader.close();  }  // 文件夹内容转换成文件夹树  const children = convertChildren(content);  // 填充文件夹树  fillFolderTree(children);  return true;}/** * 解析 RAR */async function onUncompressRAR() {  console.log("开始解析 RAR")  const content = JSON.parse(await invoke('read_rar_data', {path: props.filePath}));  console.log("RAR 文件内容：", content)  // 文件夹内容转换成文件夹树  const children = convertChildren(content);  // 填充文件夹树  fillFolderTree(children);  return true;}/** * 解析 TAR */async function onUncompressTAR() {  console.log("开始解析 TAR")  const content = JSON.parse(await invoke('read_tar_data', {path: props.filePath}));  console.log("TAR 文件内容：", content)  // 文件夹内容转换成文件夹树  const children = convertChildren(content);  // 填充文件夹树  fillFolderTree(children);  return true;}/** * 解析 GZIP */async function onUncompressGZIP() {  console.log("开始解析 GZIP")  const content = JSON.parse(await invoke('read_gzip_data', {path: props.filePath}));  console.log("TAR 文件内容：", content)  // 文件夹内容转换成文件夹树  const children = convertChildren(content);  // 填充文件夹树  fillFolderTree(children);  return true;}/** * 填充文件夹树 * @param children 文件夹内容 */function fillFolderTree(children: PackageTreeOption[]) {  const baseFileName = filePathConvertFileName(props.filePath);  folderTree.value = [{    key: baseFileName,    label: baseFileName,    children,    prefix: () => h(CloseFolderIcon, null, {default: () => h(CloseFolderIcon)}),    suffix: () => h(NGradientText, {type: 'success'}, {      default: () => {        return children.map(node => (node.fileCount || 1) + 1).reduce((acc, count) => acc + count, 0) + "个文件"      }    })  }];}watch(() => props.filePath, loadFileInfo)onMounted(loadFileInfo)</script><template>  <div v-if="fileData.isLoadingFile" class="empty-container">    <n-spin/>  </div>  <div v-else-if="!fileData.canPreview" class="file-to-big-container">    <file-to-big-icon class="file-to-big-icon"/>    <span class="file-to-big-text">      文件大小超过 1G，暂不支持预览，请点击右上角打开文件所在位置进行浏览    </span>  </div>  <div v-else-if="fileData.isEncrypt" class="file-to-big-container" @click="fileData.showPasswordModel = true">    <encrypted-icon class="file-to-big-icon"/>    <span class="file-to-big-text">      文件已加密，请先输入密码，才能进行预览    </span>  </div>  <div v-else class="folder-container">    <n-tree        :data="folderTree"        :on-update:expanded-keys="updatePrefixWithExpanded"        expand-on-click        show-line        cascade        block-line    />  </div>  <div class="file-info">    <div>文件大小：{{ fileData.size }}</div>    <div>文件类型：{{ fileData.type }}</div>  </div>  <n-modal      v-model:show="fileData.showPasswordModel"      title="压缩包已加密"      preset="dialog"  >    <n-input        v-model:value="fileData.password"        type="password"        placeholder="请输入解压缩密码"        autofocus        :readonly="fileData.onUncompressLoading"        show-password-on="click"    />    <template #action>      <n-button type="primary" :loading="fileData.onUncompressLoading" @click="onUncompressing">解压缩</n-button>    </template>  </n-modal></template><style scoped>.empty-container {  width: 100%;  height: 95%;  border: 0;  display: flex;  justify-content: center;  align-items: center;  flex-direction: column;}.folder-container {  width: 100%;  height: 95%;  overflow-y: auto;}.file-to-big-container {  width: 100%;  height: 95%;  display: flex;  flex-direction: column;  justify-content: center;  align-items: center;}.file-to-big-icon {  width: 40%;  height: auto;  opacity: 0.8;}.file-to-big-text {  width: 70%;  text-align: center;  font-size: 16px;  opacity: 0.8;}.file-info {  display: flex;  justify-content: space-between;}</style>