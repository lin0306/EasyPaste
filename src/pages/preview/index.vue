<script setup lang="ts">import TitleBar from "../../components/TitleBar.vue";import {useLanguage} from "../../services/LanguageService.ts";import {onMounted, onUnmounted, reactive, watch} from "vue";import {isImage} from "../../utils/ImageUtil.ts";import {filePathConvertFileName, isText} from "../../utils/TextUtil.ts";import VideoPreview from "./components/VideoPreview.vue";import ImagePreview from "./components/ImagePreview.vue";import {isVideo} from "../../utils/VideoUtil.ts";import UnknownFileIcon from "../../assets/icons/UnknownFileIcon.vue";import {invoke} from "@tauri-apps/api/core";import {isMac} from "../../data/SystemParams.ts";import CodePreview from "./components/CodePreview.vue";import {isCode} from "../../utils/CodeUtil.ts";import {isAudio} from "../../utils/AudioUtil.ts";import AudioPreview from "./components/AudioPreview.vue";import FolderPreview from "./components/FolderPreview.vue";import OfficePreview from "./components/OfficePreview.vue";import {isOffice} from "../../utils/OfficeUtil.ts";import TextPreview from "./components/text/TextPreview.vue";import PackagePreview from "./components/PackagePreview.vue";import {isPackage} from "../../utils/PackageUtil.ts";import OpenFolderLocationIcon from "../../assets/icons/OpenFolderLocationIcon.vue";import {listen} from "@tauri-apps/api/event";import {convertFileSize, getFileSize} from "../../utils/FileUtil.ts";import {getType} from "../../constants/FileTypeConstatnts.ts";const {currentLanguage} = useLanguage();const fileInfo = reactive({  filePath: '',  isFolder: false,  size: '0B',  type: 'application/octet-stream',});/** * 初始化文件更新监听器 */let reloadFilePathListener: any = null;/** * 打开文件所在目录 */async function openInFolder() {  // 获取文件所在目录  const path = fileInfo.filePath.includes('.') ? fileInfo.filePath.substring(0, fileInfo.filePath.lastIndexOf(isMac ? "/" : "\\")) : fileInfo.filePath;  await invoke('open_folder', {path: path})}async function initReloadFilePathListener() {  return await listen('reload-preview', async (event: any) => {    fileInfo.filePath = event.payload.filePath;    fileInfo.isFolder = event.payload.isFolder;    // 更新窗口url    window.history.replaceState(null, '', `${window.location.origin}${window.location.pathname}?filePath=${encodeURIComponent(fileInfo.filePath)}&isFolder=${fileInfo.isFolder}`);  });}async function loadFileInfo() {  const size = await getFileSize(fileInfo.filePath);  fileInfo.size = convertFileSize(size);  fileInfo.type = getType(fileInfo.filePath);}watch(() => fileInfo.filePath, loadFileInfo)onMounted(async () => {  const searchParams = new URLSearchParams(window.location.search);  fileInfo.filePath = <string>searchParams.get('filePath');  fileInfo.isFolder = <string>searchParams.get('isFolder') === "true";  await loadFileInfo();  // 初始化文件更新监听器  reloadFilePathListener = await initReloadFilePathListener();})onUnmounted(() => {  // 销毁文件更新监听器  if (reloadFilePathListener) {    reloadFilePathListener();  }})</script><template>  <TitleBar :title="currentLanguage.pages.preview.title"            :showCloseBtn="true"            :dev-tool="`preview`"/>  <div class="viewer-container">    <div class="viewer-header">      <div class="viewer-file-path">{{ currentLanguage.pages.preview.filePathLabel }}        {{ filePathConvertFileName(fileInfo.filePath) }}      </div>      <open-folder-location-icon @click="openInFolder" class="folder-icon"/>    </div>    <n-divider/>    <div class="viewer-content">      <folder-preview v-if="fileInfo.isFolder" :file-path="fileInfo.filePath"/>      <image-preview v-else-if="isImage(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <video-preview v-else-if="isVideo(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <audio-preview v-else-if="isAudio(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <code-preview v-else-if="isCode(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <office-preview v-else-if="isOffice(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <text-preview v-else-if="isText(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <package-preview v-else-if="isPackage(fileInfo.filePath)" :file-path="fileInfo.filePath"/>      <div v-else class="unknown-file-container">        <unknown-file-icon class="unknown-file-icon"/>        <span class="unknown-file-text">          {{ currentLanguage.pages.preview.cannotPreview }}        </span>      </div>    </div>  </div>  <div class="file-info">    <div>{{ currentLanguage.pages.preview.fileSize }}{{ fileInfo.size }}</div>    <n-ellipsis style="max-width: 70%">{{ currentLanguage.pages.preview.fileType }}{{ fileInfo.isFolder ? currentLanguage.pages.preview.folder : fileInfo.type }}</n-ellipsis>  </div></template><style scoped>.viewer-container {  margin: 15px;  overflow-y: auto;}.viewer-header {  display: flex;  justify-content: space-between;  gap: 6px;  width: 100%;}.viewer-file-path {  line-height: normal;}.folder-icon {  width: 25px;  opacity: 0.6;}.folder-icon:hover {  opacity: 1;}/*noinspection CssUnusedSymbol*/:deep(.n-divider:not(.n-divider--vertical)) {  margin-top: 5px !important;  margin-bottom: 7px !important;}.viewer-content {  padding: 5px;  height: calc(100vh - 140px);}.unknown-file-container {  width: 100%;  height: 100%;  display: flex;  flex-direction: column;  justify-content: center;  align-items: center;}.unknown-file-icon {  width: 40%;  height: auto;  opacity: 0.8;}.unknown-file-text {  width: 70%;  text-align: center;  font-size: 16px;  opacity: 0.8;}.file-info {  display: flex;  justify-content: space-between;  padding: 0 15px;}:deep(.no-preview-container) {  width: 100%;  height: 95%;  border: 0;  display: flex;  flex-direction: column;  justify-content: center;  align-items: center;}:deep(.no-preview-icon) {  width: 40%;  height: auto;  opacity: 0.8;}:deep(.no-preview-text) {  width: 70%;  text-align: center;  font-size: 16px;  opacity: 0.8;}</style>