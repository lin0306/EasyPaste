import {reactive, ref} from "vue";import {loadPluginManifest} from "../../../utils/PluginUtil.ts";import {dirname, join} from "@tauri-apps/api/path";import {exists, mkdir, writeFile} from "@tauri-apps/plugin-fs";import {deleteFolder} from "../../../utils/FileUtil.ts";import {fetch} from "@tauri-apps/plugin-http";import {isMac} from "../../../data/SystemParams.ts";import ClipboardDBService from "../../../services/ClipboardDBService.ts";import {MessageApiInjection} from "naive-ui/es/message/src/MessageProvider";import {BlobReader, BlobWriter, ZipReader} from "@zip.js/zip.js";import {error} from "@tauri-apps/plugin-log";import {emit} from "@tauri-apps/api/event";import {currentLanguage} from "../../../services/LanguageService.ts";import {getPluginPath} from "../../../store/Settings.ts";export const tabValue = ref<string>("local");export const pluginStore = ref<StorePlugin[]>([]);export const localPlugins = ref<LocalPlugin[]>([]);export const selectedPlugin = reactive({} as SelectPlugin);export const loadingSet = ref<Set<string>>(new Set<string>());export const storeListLoading = ref(false);export const localListLoading = ref(false);/** * 判断插件是否有更新 * @param pluginId 插件id */export function hasUpdate(pluginId: string) {    const localPlugin = localPlugins.value.find(l => l.plugin_id === pluginId);    const storePlugin = pluginStore.value.find(p => p.id === pluginId);    return localPlugin && storePlugin && localPlugin.version !== storePlugin.version;}/** * 判断插件是否安装 * @param pluginId 插件id */export function isInstall(pluginId: string) {    if (localPlugins.value && localPlugins.value.length > 0) {        return localPlugins.value.some(l => l.plugin_id === pluginId);    }    return false;}/** * 获取本地插件 * @param id 插件唯一id */export function getLocalPlugin(id: string): LocalPlugin | null {    const find = localPlugins.value.find(l => l.plugin_id === id);    return find ? find : null;}/** * 安装插件 */export async function install(pluginId: string, message: MessageApiInjection) {    const plugin = pluginStore.value.find(p => p.id === pluginId);    if (plugin) {        console.log("开始安装插件", plugin);        loadingSet.value.add(plugin.id);        const configDir = await getPluginPath();        const pluginFolderPath = await join(configDir, plugin.id);        // 删除已安装的插件        if (await exists(pluginFolderPath)) {            await deleteFolder(pluginFolderPath);        }        console.log("插件安装目录", pluginFolderPath)        try {            console.log("开始下载文件", plugin, plugin.downloadUrl)            if (plugin && plugin.downloadUrl) {                // 下载并解压文件                await installPluginFile(plugin.downloadUrl, pluginFolderPath);                // 保存插件信息                await savePluginInfo(plugin);                // 重新加载插件                await loadLocalPlugins();                // 保存插件配置                message.success(currentLanguage.value.pages.pluginStore.installSuccessHint.replace("${pluginName}", plugin.name));                await emit('install-plugin', {pluginId: pluginId});            } else {                message.error(currentLanguage.value.pages.pluginStore.installNotUrlHint);            }        } catch (error) {            console.error('下载失败:', error);            message.error(currentLanguage.value.pages.pluginStore.installFailedHint);            deleteFolder(pluginFolderPath);        } finally {            loadingSet.value.delete(plugin.id);        }    }}/** * 安装插件文件 * @param url 插件下载地址 * @param pluginFolderPath 插件安装目录 */async function installPluginFile(url: string, pluginFolderPath: string) {    // 文件下载    const response = await fetch(url, {method: 'GET'});    console.log("文件下载完成，开始解压文件", response);    await mkdir(pluginFolderPath, {recursive: true});    // 文件解压    const blob = await response.blob();    const reader = new ZipReader(new BlobReader(blob));    const entries = await reader.getEntries();    let processedFiles = 0;    // 获取根目录名    const rootDirName = entries[0].filename.split('/')[0];    const rootDirPrefix = rootDirName + '/';    for (const entry of entries) {        // 移除根目录前缀        let relativePath = entry.filename;        if (relativePath.startsWith(rootDirPrefix)) {            relativePath = relativePath.substring(rootDirPrefix.length);        }        if (!relativePath || relativePath === "/" || relativePath === "\\") {            continue;        }        if (!entry.directory) {            const data = await entry.getData(new BlobWriter());            const targetPath = await join(pluginFolderPath, relativePath);            console.log("保存文件", targetPath);            const parentDir = await dirname(targetPath);            await mkdir(parentDir, {recursive: true});            await writeFile(targetPath, new Uint8Array(await data.arrayBuffer()));        } else if (relativePath !== '') {            // 处理子目录            const targetPath = await join(pluginFolderPath, relativePath);            await mkdir(targetPath, {recursive: true});        }        processedFiles++;    }    await reader.close();}/** * 保存插件信息 * @param value 插件信息 */async function savePluginInfo(value: StorePlugin) {    const manifest = await loadPluginManifest(value.id);    if (!manifest) {        throw new Error("未找到插件配置文件");    }    console.log("加载" + value.id, manifest)    const useLocationSet = new Set();    const features = manifest.features;    if (features) {        for (let feature of features) {            if (feature.page && feature.page !== "plugins") {                useLocationSet.add(feature.page);            }        }    }    console.log(useLocationSet, JSON.stringify([...useLocationSet]));    // 保存插件信息    const db = await ClipboardDBService.getInstance();    await db.addPlugin({        id: 0,        enable: 1,        plugin_id: value.id,        plugin_name: value.name,        version: value.version,        use_location: JSON.stringify([...useLocationSet]),        platform: value.platform,        url: value.downloadUrl,        description: value.description,        install_time: 0,    })}/** * 卸载插件 */export async function uninstall(pluginId: string, message: MessageApiInjection) {    const plugin = localPlugins.value.find(p => p.plugin_id === pluginId);    if (plugin) {        try {            console.log("开始卸载插件", plugin.plugin_id)            loadingSet.value.add(plugin.plugin_id);            if (plugin.id && plugin.id > 0) {                await emit('uninstall-plugin', {pluginId: plugin.plugin_id});                // 删除插件数据                const db = await ClipboardDBService.getInstance();                await db.removePlugin(plugin.id);                // 删除插件文件夹                const configDir = await getPluginPath();                const pluginFolderPath = await join(configDir, `${plugin.plugin_id}`);                await deleteFolder(pluginFolderPath);                // 重新加载插件                await loadLocalPlugins();                message.success(currentLanguage.value.pages.pluginStore.uninstallSuccessHint);            } else {                message.error(currentLanguage.value.pages.pluginStore.notInstallHint);                await loadLocalPlugins();            }        } catch (e) {            console.error(e);            message.error(currentLanguage.value.pages.pluginStore.uninstallFailedHint);        } finally {            loadingSet.value.delete(plugin.plugin_id);        }    }}/** * 插件更新 */export async function update(pluginId: string, message: MessageApiInjection) {    if (pluginId) {        const storePlugin = pluginStore.value.find(l => l.id === pluginId);        const localPlugin = localPlugins.value.find(l => l.plugin_id === pluginId);        if (storePlugin) {            if (localPlugin) {                if (storePlugin && storePlugin.downloadUrl) {                    try {                        console.log("开始更新插件", storePlugin, storePlugin.downloadUrl)                        loadingSet.value.add(storePlugin.id);                        const configDir = await getPluginPath();                        const pluginFolderPath = await join(configDir, selectedPlugin.plugin_id);                        console.log("插件安装目录", pluginFolderPath)                        // 卸载插件                        try {                            await emit('uninstall-plugin', {pluginId: pluginId});                            await deleteFolder(pluginFolderPath);                        } catch (e) {                            error("插件卸载失败" + e);                            console.log("插件卸载失败", e);                            message.error(currentLanguage.value.pages.pluginStore.updateUnInstallFailedHint)                            return;                        }                        // 安装插件                        try {                            console.log("开始下载文件", storePlugin, storePlugin.downloadUrl)                            // 下载并解压文件                            await installPluginFile(storePlugin.downloadUrl, pluginFolderPath);                            // 保存插件信息                            await updatePluginInfo(localPlugin.id, storePlugin);                            // 重新加载插件                            await loadLocalPlugins();                            await emit('install-plugin', {pluginId: pluginId});                            // 保存插件配置                            message.success(currentLanguage.value.pages.pluginStore.updateSuccessHint.replace("${pluginName}", storePlugin.name));                        } catch (e) {                            error("插件安装失败" + e);                            await deleteFolder(pluginFolderPath);                            const db = await ClipboardDBService.getInstance();                            await db.removePlugin(localPlugin.id);                            message.error(currentLanguage.value.pages.pluginStore.updateFailedHint);                            await loadLocalPlugins();                        }                    } finally {                        loadingSet.value.delete(storePlugin.id);                    }                } else {                    message.error(currentLanguage.value.pages.pluginStore.installNotUrlHint);                }            } else {                // 本地没有安装插件，执行安装操作                await install(pluginId, message);            }        } else {            message.error(currentLanguage.value.pages.pluginStore.notPluginHint);        }    } else {        message.error(currentLanguage.value.pages.pluginStore.notSelectPluginHint);    }}/** * 保存插件信息 * @param id 插件id * @param value 插件信息 */async function updatePluginInfo(id: number, value: StorePlugin) {    if (id) {        const manifest = await loadPluginManifest(value.id);        if (!manifest) {            throw new Error("未找到插件配置文件");        }        console.log("加载" + value.id, manifest)        const useLocationSet = new Set();        const features = manifest.features;        if (features) {            for (let feature of features) {                if (feature.page && feature.page !== "plugins") {                    useLocationSet.add(feature.page);                }            }        }        // 保存插件信息        const db = await ClipboardDBService.getInstance();        await db.updatePlugin({            id: id,            plugin_id: value.id,            plugin_name: value.name,            version: value.version,            use_location: JSON.stringify(useLocationSet),            platform: value.platform,            url: value.downloadUrl,            description: value.description,            enable: 1,            install_time: 0,        })    }}/** * 选择本地插件 * @param plugin 本地插件 */export function onSelectLocal(plugin: LocalPlugin) {    selectedPlugin.id = plugin.id;    selectedPlugin.plugin_id = plugin.plugin_id;    selectedPlugin.plugin_name = plugin.plugin_name;    selectedPlugin.version = plugin.version;    selectedPlugin.platform = plugin.platform;    selectedPlugin.url = plugin.url;    selectedPlugin.description = plugin.description;    selectedPlugin.enable = plugin.enable;}/** * 选择商店插件 * @param plugin 商店插件 */export function onSelectStore(plugin: StorePlugin) {    const localPlugin = getLocalPlugin(plugin.id);    selectedPlugin.id = localPlugin ? localPlugin.id : 1;    selectedPlugin.enable = localPlugin ? localPlugin.enable : 1;    selectedPlugin.plugin_id = plugin.id;    selectedPlugin.plugin_name = plugin.name;    selectedPlugin.url = plugin.downloadUrl;    selectedPlugin.version = plugin.version;    selectedPlugin.platform = plugin.platform;    selectedPlugin.description = plugin.description;}/** * 清空选择的插件 */export function clearSelectPlugin() {    selectedPlugin.id = null;    selectedPlugin.plugin_id = '';}/** * 启用/禁用插件 * @param pluginId 插件id * @param enable 启用/禁用 */export async function togglePluginEnable(pluginId: string, enable: boolean) {    try {        loadingSet.value.add(pluginId);        const plugin = localPlugins.value.find(l => l.plugin_id === pluginId);        if (selectedPlugin.plugin_id === pluginId) {            selectedPlugin.enable = (enable ? 1 : 0);        }        localPlugins.value.forEach(l => {            if (l.plugin_id === pluginId) {                l.enable = enable ? 1 : 0;            }        })        if (plugin) {            const db = await ClipboardDBService.getInstance();            await db.togglePluginEnable(plugin.id, enable ? 1 : 0);            // 发送消息加载或取消加载插件            await loadLocalPlugins();            console.log("插件启用/禁用成功", pluginId, enable);        }    } catch (e) {        error("插件启用/禁用异常" + e);    } finally {        setTimeout(() => {            loadingSet.value.delete(pluginId);        }, 300);    }}/** * 获取插件商店数据 */async function loadPluginStore() {    try {        storeListLoading.value = true;        const response = await fetch(            'https://gh-proxy.com/https://raw.githubusercontent.com/lin0306/EasyPaste-Plugins/master/plugins-list.json',            {method: 'GET'}        );        const data: StorePlugin[] = await response.json();        console.log("插件商店数据", data)        // 筛选出当前操作系统的插件        if (isMac) {            pluginStore.value = data.filter(p => p.platform === "Mac" || p.platform === "General");        } else {            pluginStore.value = data.filter(p => p.platform === "Windows" || p.platform === "General");        }        console.log("插件商店数据：", pluginStore.value);    } catch (error) {        console.error('Error fetching JSON:', error);    } finally {        setTimeout(() => {            storeListLoading.value = false;        }, 200)    }}/** * 获取本地插件数据 */async function loadLocalPlugins() {    try {        console.log("获取本地插件数据")        localListLoading.value = true;        const db = await ClipboardDBService.getInstance();        const plugins = await db.getAllPlugins();        console.log("本地插件数据：", plugins)        localPlugins.value = plugins;    } catch (e) {        error("获取本地插件数据异常" + e);    } finally {        setTimeout(() => {            localListLoading.value = false;        }, 200)    }}/** * 初始化插件数据 */export async function initializePlugins() {    try {        // 获取本地插件数据        await loadLocalPlugins();        // 获取插件商店数据        await loadPluginStore();        if (localPlugins.value && tabValue.value === "local") {            onSelectLocal(localPlugins.value[0]);            console.log(localPlugins.value, selectedPlugin)        }    } catch (e) {        await error("插件数据加载失败" + e);    }}